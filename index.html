<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EcoRota | App Oficial</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3202/3202926.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* DESIGN SYSTEM STARTUP */
        :root { --primary: #059669; --dark: #0f172a; --light: #f8fafc; --gray: #64748b; --radius: 12px; --shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--light); overflow: hidden; height: 100vh; width: 100vw; color: var(--dark); }

        /* TELAS */
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; transition: opacity 0.3s ease; }
        .hidden { display: none !important; }
        
        .brand { font-size: 2.2rem; font-weight: 800; color: var(--dark); margin-bottom: 30px; letter-spacing: -1px; }
        .brand span { color: var(--primary); }

        /* TAB SELECTOR */
        .tab-group { display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; margin-bottom: 20px; width: 100%; max-width: 320px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; border-radius: 8px; font-weight: 600; color: var(--gray); cursor: pointer; transition: 0.3s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* INPUTS */
        .input-group { width: 100%; max-width: 320px; margin-bottom: 12px; }
        .input-field { width: 100%; padding: 16px; border: 1px solid #cbd5e1; border-radius: var(--radius); font-size: 1rem; outline: none; transition: 0.2s; background: white; }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1); }

        /* TERMOS JUR√çDICOS ROBUSTOS */
        .legal-wrapper { width: 100%; max-width: 320px; margin-bottom: 15px; }
        .legal-box { height: 150px; overflow-y: auto; background: #f8fafc; padding: 15px; border: 1px solid #e2e8f0; border-radius: var(--radius); font-size: 0.75rem; color: #475569; text-align: justify; line-height: 1.5; margin-bottom: 10px; }
        .legal-title { font-weight: bold; color: var(--dark); margin-top: 10px; display: block; }
        
        /* BOT√ïES */
        .btn { width: 100%; max-width: 320px; padding: 16px; border: none; border-radius: var(--radius); font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1rem; transition: 0.2s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--dark); color: white; }
        .btn-eco { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(5, 150, 105, 0.2); }
        .btn-google { background: white; border: 1px solid #cbd5e1; color: #334155; margin-bottom: 20px; }

        /* MAPA E PAIN√âIS */
        #map { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; filter: saturate(0.9); }
        .bottom-panel { position: absolute; bottom: 0; left: 0; width: 100%; background: white; border-radius: 24px 24px 0 0; padding: 25px; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); z-index: 100; }
        .panel-visible { transform: translateY(0); }

        /* LISTA DE PEDIDOS */
        #orders-list { max-height: 40vh; overflow-y: auto; }
        .order-card { background: #ecfdf5; border: 1px solid #d1fae5; padding: 16px; border-radius: 12px; margin-bottom: 12px; animation: slideIn 0.3s; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; background: #059669; color: white; }
        
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="screen-auth" class="screen">
        <div class="brand">Eco<span>Rota</span></div>
        
        <button class="btn btn-google" onclick="showForm()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> 
            Entrar com Google
        </button>

        <div id="auth-form" class="hidden" style="width:100%; display:flex; flex-direction:column; align-items:center;">
            
            <div class="tab-group">
                <button class="tab-btn active" onclick="switchRole('user')" id="btn-tab-user">Sou Cliente</button>
                <button class="tab-btn" onclick="switchRole('prov')" id="btn-tab-prov">Sou Prestador</button>
            </div>

            <div class="input-group">
                <input id="input-name" class="input-field" placeholder="Nome Completo (RG)">
            </div>
            <div class="input-group">
                <input id="input-phone" class="input-field" type="tel" placeholder="WhatsApp (DDD)">
            </div>
            
            <div id="group-vehicle" class="input-group hidden">
                <select id="input-veh" class="input-field" style="background: #f8fafc;">
                    <option value="" disabled selected>Selecione seu Ve√≠culo</option>
                    <option value="Bike">üö≤ Bicicleta Comum</option>
                    <option value="E-Bike">‚ö° Bicicleta El√©trica</option>
                    <option value="Patinete">üõ¥ Patinete El√©trico</option>
                    <option value="A P√©">üëü A P√© (Office Boy)</option>
                </select>
            </div>

            <div class="legal-wrapper">
                <label style="font-size:0.8rem; font-weight:bold; color:var(--dark);">Termos de Uso e Responsabilidade</label>
                <div class="legal-box" id="legal-scroll">
                    <span class="legal-title">1. NATUREZA DO SERVI√áO</span>
                    A plataforma EcoRota atua exclusivamente como intermediadora tecnol√≥gica entre Usu√°rios e Prestadores Aut√¥nomos. N√£o possu√≠mos frota e n√£o estabelecemos v√≠nculo empregat√≠cio.
                    
                    <span class="legal-title">2. RESPONSABILIDADE CIVIL</span>
                    O uso do servi√ßo √© de inteira responsabilidade e conta e risco das partes. A plataforma isenta-se de danos, perdas ou atrasos decorrentes da presta√ß√£o direta.
                    
                    <span class="legal-title">3. PAGAMENTOS P2P</span>
                    Os valores s√£o negociados e pagos diretamente entre as partes. A plataforma n√£o ret√©m valores financeiros.
                    
                    <span class="legal-title">4. COMPROMISSO AMBIENTAL</span>
                    √â estritamente proibido o uso de ve√≠culos a combust√£o. O descumprimento acarretar√° banimento imediato.
                    
                    <span class="legal-title">5. DADOS E PRIVACIDADE</span>
                    Seus dados de localiza√ß√£o s√£o utilizados apenas durante a solicita√ß√£o ativa.
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="check-terms" onchange="toggleEnterBtn()">
                    <label for="check-terms" style="font-size:0.85rem; color:var(--gray);">Li, compreendi e aceito os termos.</label>
                </div>
            </div>

            <button id="btn-enter" class="btn btn-eco" onclick="doLogin()" disabled>ACESSAR PLATAFORMA</button>
        </div>
    </div>

    <div id="screen-map" class="screen hidden" style="background:transparent; padding:0;">
        <div id="map"></div>

        <div id="panel-user" class="bottom-panel">
            <h3 style="margin-top:0;">Nova Solicita√ß√£o</h3>
            <div class="input-group" style="max-width:100%;">
                <select id="req-type" class="input-field">
                    <option value="Bike">üö≤ Bike (Encomenda)</option>
                    <option value="E-Bike">‚ö° E-Bike (R√°pido)</option>
                    <option value="A P√©">üëü A P√© (Curto)</option>
                </select>
            </div>
            <div class="input-group" style="max-width:100%;">
                <input id="req-desc" class="input-field" placeholder="O que precisa? (Ex: Buscar chave na Rua X)">
            </div>
            <button class="btn btn-primary" style="max-width:100%;" onclick="enviarPedido()">SOLICITAR AGORA</button>
        </div>

        <div id="panel-waiting" class="bottom-panel" style="text-align:center;">
            <div style="width:60px; height:60px; border:4px solid #059669; border-top-color:transparent; border-radius:50%; margin:0 auto 20px auto; animation:spin 1s linear infinite;"></div>
            <h3>Procurando Parceiro...</h3>
            <p style="color:var(--gray);">Aguarde, estamos conectando voc√™.</p>
            <button class="btn btn-outline" style="margin-top:20px; width:100%; border:1px solid #ccc;" onclick="cancelarPedido()">CANCELAR</button>
        </div>

        <div id="panel-prov" class="bottom-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Pedidos Dispon√≠veis</h3>
                <span style="background:#dcfce7; color:#166534; padding:5px 10px; border-radius:15px; font-size:0.7rem; font-weight:bold;">‚óè ONLINE</span>
            </div>
            <div id="orders-list">
                <p style="text-align:center; color:#94a3b8; padding:20px;">Nenhum pedido na regi√£o.</p>
            </div>
        </div>
    </div>

    <script>
        // --- CHAVES FIREBASE VINCULADAS (MODO TESTE ABERTO) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBxbRiYNuGde5nwJIaoeRItWdZGR221cpY",
            authDomain: "rota-direta.firebaseapp.com",
            databaseURL: "https://rota-direta-default-rtdb.firebaseio.com",
            projectId: "rota-direta",
            storageBucket: "rota-direta.firebasestorage.app",
            messagingSenderId: "468273971962",
            appId: "1:468273971962:web:f536de2e2aa74f84dfff43"
        };

        // INICIALIZA√á√ÉO SEGURA
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("Sistema Conectado.");
        } catch(e) {
            Swal.fire('Erro Fatal', 'Falha na conex√£o com servidor.', 'error');
        }

        // VARI√ÅVEIS GLOBAIS
        let map, role = 'user', currentUser = {}, currentOrderId = null;
        const audioAlert = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        // M√ÅSCARA TELEFONE AO CARREGAR
        window.onload = () => { IMask(document.getElementById('input-phone'), {mask:'(00) 00000-0000'}); };

        // 1. L√ìGICA DE UI (LOGIN)
        function showForm() {
            document.querySelector('.btn-google').classList.add('hidden');
            document.getElementById('auth-form').classList.remove('hidden');
        }

        function switchRole(selectedRole) {
            role = selectedRole;
            // Visual das abas
            document.getElementById('btn-tab-user').className = `tab-btn ${role === 'user' ? 'active' : ''}`;
            document.getElementById('btn-tab-prov').className = `tab-btn ${role === 'prov' ? 'active' : ''}`;
            
            // Mostrar/Esconder campo de ve√≠culo
            const vehGroup = document.getElementById('group-vehicle');
            if(role === 'prov') {
                vehGroup.classList.remove('hidden');
            } else {
                vehGroup.classList.add('hidden');
            }
        }

        function toggleEnterBtn() {
            document.getElementById('btn-enter').disabled = !document.getElementById('check-terms').checked;
        }

        // 2. L√ìGICA DE ENTRADA (AUTH)
        function doLogin() {
            const name = document.getElementById('input-name').value.trim();
            const phone = document.getElementById('input-phone').value;
            
            // Valida√ß√µes Rigorosas
            if(name.split(' ').length < 2) return Swal.fire('Nome Inv√°lido', 'Por favor, digite Nome e Sobrenome.', 'warning');
            if(phone.length < 14) return Swal.fire('WhatsApp', 'N√∫mero inv√°lido.', 'warning');
            
            currentUser = { name, phone };

            if(role === 'prov') {
                const veh = document.getElementById('input-veh').value;
                if(!veh) return Swal.fire('Ve√≠culo', 'Selecione seu tipo de transporte.', 'warning');
                currentUser.vehicle = veh;
            }

            // Transi√ß√£o de Tela
            document.getElementById('screen-auth').classList.add('hidden');
            document.getElementById('screen-map').classList.remove('hidden');
            
            initMap();

            // Abre o painel correto
            if(role === 'user') {
                setTimeout(() => document.getElementById('panel-user').classList.add('panel-visible'), 500);
            } else {
                setTimeout(() => document.getElementById('panel-prov').classList.add('panel-visible'), 500);
                iniciarEscutaPrestador(); // Come√ßa a ouvir o banco
            }
        }

        // 3. MAPA (LEAFLET)
        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([-21.135, -44.261], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

            // √çcone Personalizado
            const iconUrl = role === 'user' 
                ? 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png' // User
                : 'https://cdn-icons-png.flaticon.com/512/609/609803.png';   // Prestador

            navigator.geolocation.getCurrentPosition(p => {
                const lat = p.coords.latitude;
                const lng = p.coords.longitude;
                currentUser.lat = lat; currentUser.lng = lng;
                
                map.setView([lat, lng], 16);
                L.marker([lat, lng], {
                    icon: L.icon({iconUrl: iconUrl, iconSize: [40, 40]})
                }).addTo(map);
            }, () => Swal.fire('GPS', 'Ative sua localiza√ß√£o.', 'info'), {enableHighAccuracy:true});
        }

        // 4. CLIENTE: ENVIAR PEDIDO
        function enviarPedido() {
            const type = document.getElementById('req-type').value;
            const desc = document.getElementById('req-desc').value;

            if(!desc) return Swal.fire('Aten√ß√£o', 'Descreva o que precisa ser feito.', 'info');

            // Salva no Firebase
            const newOrderRef = db.ref('orders').push();
            currentOrderId = newOrderRef.key;

            const orderData = {
                id: currentOrderId,
                clientName: currentUser.name,
                clientPhone: currentUser.phone,
                type: type,
                desc: desc,
                lat: currentUser.lat || 0,
                lng: currentUser.lng || 0,
                status: 'pending',
                timestamp: Date.now()
            };

            newOrderRef.set(orderData);

            // Troca Painel
            document.getElementById('panel-user').classList.remove('panel-visible');
            document.getElementById('panel-waiting').classList.add('panel-visible');

            // Fica ouvindo se algu√©m aceita
            newOrderRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if(data && data.status === 'accepted') {
                    // SUCESSO!
                    audioAlert.play();
                    Swal.fire({
                        title: 'Parceiro Encontrado! üåü',
                        html: `
                            <div style="text-align:center;">
                                <h3 style="color:#059669;">${data.provName}</h3>
                                <p class="badge">${data.provVeh}</p>
                                <p style="margin-top:10px;">Estou a caminho!</p>
                            </div>
                        `,
                        confirmButtonText: '<i class="fab fa-whatsapp"></i> ABRIR CONVERSA',
                        confirmButtonColor: '#25D366'
                    }).then(() => {
                        const cleanPhone = data.provPhone.replace(/\D/g, '');
                        window.open(`https://wa.me/55${cleanPhone}`, '_blank');
                        location.reload();
                    });
                }
            });
        }

        // 5. PRESTADOR: OUVIR PEDIDOS
        function iniciarEscutaPrestador() {
            const ordersRef = db.ref('orders');
            
            // Filtra apenas os pendentes
            ordersRef.orderByChild('status').equalTo('pending').on('value', (snapshot) => {
                const list = document.getElementById('orders-list');
                list.innerHTML = '';

                if(!snapshot.exists()) {
                    list.innerHTML = '<p style="text-align:center; color:#94a3b8; padding:20px;">Nenhum pedido na regi√£o.</p>';
                    return;
                }

                // Toca som se a lista crescer
                audioAlert.play().catch(e => console.log('Intera√ß√£o necess√°ria para √°udio'));

                snapshot.forEach((child) => {
                    const order = child.val();
                    const card = document.createElement('div');
                    card.className = 'order-card';
                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; align-items:start;">
                            <div>
                                <span class="badge">${order.type}</span>
                                <h4 style="margin:5px 0;">${order.clientName}</h4>
                            </div>
                            <small style="color:var(--gray);">Agora</small>
                        </div>
                        <p style="color:#475569; font-size:0.9rem;">"${order.desc}"</p>
                        <button class="btn btn-eco" style="width:100%; margin-top:10px; padding:12px;" onclick="aceitarCorrida('${order.id}')">
                            ACEITAR CORRIDA
                        </button>
                    `;
                    list.prepend(card); // Mais recentes primeiro
                });
            });
        }

        function aceitarCorrida(id) {
            // Atualiza o pedido com meus dados
            db.ref('orders/' + id).update({
                status: 'accepted',
                provName: currentUser.name,
                provPhone: currentUser.phone,
                provVeh: currentUser.vehicle
            });
            Swal.fire('Sucesso', 'Corrida aceita! O cliente foi notificado.', 'success');
        }

        function cancelarPedido() {
            if(currentOrderId) {
                db.ref('orders/' + currentOrderId).remove();
                location.reload();
            }
        }

        /* ANIMA√á√ÉO CSS */
        const style = document.createElement('style');
        style.innerHTML = ` @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } `;
        document.head.appendChild(style);

    </script>
</body>
</html>
