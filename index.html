<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rota Direta - Oficial</title>
    
    <link rel="manifest" href='data:application/manifest+json,{"name":"Rota Direta","short_name":"RotaApp","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#10b981","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/3202/3202926.png","sizes":"192x192","type":"image/png"}]}' />
    <meta name="theme-color" content="#10b981">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --primary: #0f172a; --eco: #10b981; --warn: #f59e0b; --err: #ef4444; --bg: #f8fafc; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); overflow: hidden; height: 100vh; width: 100vw; position: fixed; }
        
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; transition: 0.3s; overflow-y: auto; }
        .hidden { display: none !important; }
        
        .card { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 360px; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); margin: 20px 0; }
        .logo { font-size: 2rem; font-weight: 900; color: var(--primary); margin-bottom: 20px; }
        .logo span { color: var(--eco); }
        
        /* BOT√ïES & INPUTS */
        .inp { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; margin-bottom: 10px; outline: none; transition: 0.3s; }
        .inp:focus { border-color: var(--eco); background: #f0fdf4; }
        .inp.error { border-color: var(--err); background: #fef2f2; }
        
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 800; cursor: pointer; margin-top: 10px; color: white; display: flex; justify-content: center; align-items: center; gap: 8px; font-size: 1rem; }
        .btn-eco { background: var(--eco); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .btn-google { background: white; color: #333; border: 2px solid #e2e8f0; }
        .btn-outline { background: transparent; border: 2px solid #e2e8f0; color: #64748b; }

        /* MOSAICO DE SELE√á√ÉO */
        .mosaic-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-bottom: 15px; }
        .mosaic-item { border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px; text-align: center; cursor: pointer; transition: 0.2s; opacity: 0.7; }
        .mosaic-item i { font-size: 2rem; color: #64748b; margin-bottom: 5px; display: block; }
        .mosaic-item span { font-size: 0.8rem; font-weight: bold; color: #334155; }
        .mosaic-item.selected { border-color: var(--eco); background: #ecfdf5; opacity: 1; transform: scale(1.05); }
        .mosaic-item.selected i { color: var(--eco); }

        /* UI MAPA */
        #app-ui { display: none; width: 100%; height: 100%; position: relative; }
        #map { width: 100%; height: 100%; z-index: 1; }

        .float-btn { position: absolute; z-index: 2000; width: 45px; height: 45px; border-radius: 50%; background: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.15); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: #333; }
        #btn-legal { top: 20px; left: 20px; font-size: 1rem; color: var(--primary); }
        #btn-share { top: 20px; right: 20px; color: var(--accent); }
        #btn-exit { top: 80px; right: 20px; color: var(--err); }
        #btn-sos { top: 80px; left: 20px; background: var(--err); color: white; animation: pulse 2s infinite; font-weight: 900; font-size: 0.7rem; }
        
        #dock-bottom { position: absolute; bottom: 0; left: 0; right: 0; background: white; border-radius: 25px 25px 0 0; padding: 20px; z-index: 2000; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); max-height: 60vh; overflow-y: auto; }
        
        .eco-alert { font-size: 0.75rem; text-align: center; color: #64748b; margin-top: 10px; background: #f1f5f9; padding: 8px; border-radius: 8px; }

        /* CARDS */
        .offer-card { background: #fffbeb; border: 1px solid #fcd34d; padding: 15px; border-radius: 12px; margin-bottom: 10px; }
        .rating-star { color: #fbbf24; margin-right: 5px; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="screen-loading" class="screen"><div class="logo">ROTA <span>DIRETA</span></div><p>Carregando...</p></div>

    <div id="screen-login" class="screen hidden">
        <div class="logo">ROTA <span>DIRETA</span></div>
        <p style="text-align:center; color:#64748b;">Mobilidade P2P Sustent√°vel</p>
        <div class="card">
            <button class="btn btn-google" onclick="loginGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Entrar com Google
            </button>
            <p style="font-size:0.75rem; text-align:center; color:#94a3b8; margin-top:20px;">
                Ao continuar, voc√™ aceita nossos Termos de Uso.
            </p>
        </div>
    </div>

    <div id="screen-role" class="screen hidden">
        <h3 style="color:var(--primary)">Quem √© voc√™?</h3>
        <div class="card">
            <button class="btn btn-eco" onclick="setRole('passenger')">üôã SOU USU√ÅRIO</button>
            <button class="btn btn-outline" onclick="setRole('provider_setup')">üö≤ SOU PRESTADOR</button>
        </div>
    </div>

    <div id="screen-register" class="screen hidden">
        <div class="card" style="max-height:95vh; overflow-y:auto;">
            <h3 style="text-align:center; margin-top:0;">Cadastro Profissional</h3>
            <p style="font-size:0.8rem; text-align:center; color:#64748b;">Selecione seu ve√≠culo:</p>
            
            <div class="mosaic-grid">
                <div class="mosaic-item" onclick="selectVehicle('bike', this)">
                    <i class="fas fa-bicycle"></i><span>BIKE</span>
                </div>
                <div class="mosaic-item" onclick="selectVehicle('moto', this)">
                    <i class="fas fa-motorcycle"></i><span>MOTO</span>
                </div>
                <div class="mosaic-item" onclick="selectVehicle('carro', this)">
                    <i class="fas fa-car"></i><span>CARRO</span>
                </div>
                <div class="mosaic-item" onclick="selectVehicle('ape', this)">
                    <i class="fas fa-walking"></i><span>A P√â</span>
                </div>
            </div>
            <input type="hidden" id="reg-type">

            <input id="reg-nome" class="inp" placeholder="Nome Completo (Sem abreviar)">
            <input id="reg-zap" class="inp" type="tel" placeholder="WhatsApp (DDD + 9 d√≠gitos)">
            
            <label style="font-size:0.8rem; font-weight:bold; display:block; margin-bottom:5px;">Antecedentes Criminais:</label>
            <input type="file" id="reg-doc" class="inp" style="padding:10px;">

            <div style="background:#f8fafc; padding:10px; border-radius:8px; border:1px solid #e2e8f0; margin:10px 0;">
                <label style="display:flex; gap:10px; font-size:0.8rem; align-items:flex-start;">
                    <input type="checkbox" id="reg-termos">
                    <span>Li e aceito os <b style="color:var(--eco); cursor:pointer;" onclick="verTermos()">Termos de Uso Obrigat√≥rios</b> e declaro que meus dados s√£o verdadeiros.</span>
                </label>
            </div>

            <button class="btn btn-eco" onclick="enviarCadastro()">ENVIAR PARA AN√ÅLISE</button>
            <div onclick="location.reload()" style="text-align:center; margin-top:15px; cursor:pointer; font-size:0.8rem; color:#94a3b8;">Cancelar</div>
        </div>
    </div>

    <div id="screen-pending" class="screen hidden">
        <i class="fas fa-clock" style="font-size:3rem; color:var(--warn); margin-bottom:20px;"></i>
        <h3>An√°lise em Andamento</h3>
        <p style="text-align:center; color:#64748b; max-width:300px;">Seus dados est√£o com o administrador. Assim que aprovado, voc√™ entrar√° direto.</p>
        <button class="btn btn-outline" onclick="location.reload()">ATUALIZAR STATUS</button>
        <button onclick="simularAprovacao()" style="margin-top:50px; opacity:0.3; border:none; background:none;">(Dev: Auto-Aprovar)</button>
    </div>

    <div id="app-ui">
        <div id="map"></div>
        
        <button id="btn-legal" class="float-btn" onclick="verTermos()" title="Termos"><i class="fas fa-file-contract"></i></button>
        <button id="btn-share" class="float-btn" onclick="compartilhar()" title="Compartilhar"><i class="fas fa-share-alt"></i></button>
        <button id="btn-exit" class="float-btn" onclick="logout()" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
        <button id="btn-sos" class="float-btn" onclick="sos()" title="SOS POL√çCIA">SOS</button>

        <div id="dock-user" class="hidden">
            <div id="dock-bottom">
                <button class="btn btn-eco" onclick="novoPedidoUI()"><i class="fas fa-plus-circle"></i> SOLICITAR SERVI√áO</button>
                <div class="eco-alert"><i class="fas fa-info-circle"></i> Pagamento direto ao prestador. A plataforma n√£o cobra taxas.</div>
            </div>
        </div>

        <div id="dock-provider" class="hidden">
            <div id="dock-bottom">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b style="color:var(--primary)">ONLINE</b> <span style="font-size:0.8rem; color:#64748b;">‚Ä¢ <i class="fas fa-star rating-star"></i> 5.0</span>
                    </div>
                    <div style="background:#dcfce7; color:#15803d; padding:5px 10px; border-radius:15px; font-size:0.8rem; font-weight:bold;">
                        <i class="fas fa-leaf"></i> Eco Ativo
                    </div>
                </div>
                <hr style="border:0; border-top:1px solid #e2e8f0; margin:15px 0;">
                <h4 style="margin:0 0 10px 0;">Pedidos Pr√≥ximos:</h4>
                <div id="lista-ofertas">
                    <p style="text-align:center; color:#94a3b8; font-size:0.9rem;">Procurando clientes na categoria...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const firebaseConfig = { apiKey: "AIzaSyBxbRiYNuGde5nwJIaoeRItWdZGR221cpY", authDomain: "rota-direta.firebaseapp.com", projectId: "rota-direta", databaseURL: "https://rota-direta-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        let map, user, role, myMarker, watchId;
        const audioBeep = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        // √çCONES
        const icons = {
            bike: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/94/94203.png', iconSize:[32,32]}),
            moto: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/1986/1986937.png', iconSize:[32,32]}),
            carro: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/3202/3202926.png', iconSize:[32,32]}),
            ape: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/72/72908.png', iconSize:[28,28]})
        };

        // --- 1. L√ìGICA DE LOGIN UNIFICADO ---
        function loginGoogle() { auth.signInWithPopup(provider).catch(e => Swal.fire('Erro', e.message, 'error')); }

        auth.onAuthStateChanged(async (u) => {
            if (u) {
                user = u;
                document.getElementById('screen-loading').classList.remove('hidden');
                document.getElementById('screen-login').classList.add('hidden');
                
                // Verifica se j√° tem cadastro
                const snap = await db.ref('users/' + u.uid).get();
                if (snap.exists()) {
                    const data = snap.val();
                    role = data.role;
                    if (role === 'provider') {
                        if (data.status === 'approved') iniciarAppProvider(data);
                        else showScreen('screen-pending');
                    } else {
                        iniciarAppUser(data);
                    }
                } else {
                    // Novo usu√°rio: Pergunta quem √©
                    document.getElementById('screen-loading').classList.add('hidden');
                    showScreen('screen-role');
                }
            } else {
                showScreen('screen-login');
            }
        });

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        async function setRole(r) {
            if (r === 'passenger') {
                await db.ref('users/' + user.uid).set({ uid: user.uid, role: 'passenger', name: user.displayName, email: user.email, rating: 5.0 });
                location.reload();
            } else {
                showScreen('screen-register');
                setTimeout(() => IMask(document.getElementById('reg-zap'), {mask:'(00) 00000-0000'}), 500);
            }
        }

        // --- 2. CADASTRO PRESTADOR (VALIDA√á√ÉO) ---
        function selectVehicle(type, el) {
            document.querySelectorAll('.mosaic-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('reg-type').value = type;
        }

        function enviarCadastro() {
            const type = document.getElementById('reg-type').value;
            const nome = document.getElementById('reg-nome').value.trim();
            const zap = document.getElementById('reg-zap').value;
            const terms = document.getElementById('reg-termos').checked;
            const doc = document.getElementById('reg-doc').value; // Simula√ß√£o de upload

            // VALIDA√á√ÉO ANTI-LIXO
            if (!type) return Swal.fire('Falta Ve√≠culo', 'Escolha um √≠cone acima.', 'warning');
            if (nome.split(' ').length < 2 || nome.length < 5) return Swal.fire('Nome Inv√°lido', 'Digite Nome e Sobrenome reais.', 'error');
            if (zap.length < 14) return Swal.fire('WhatsApp Inv√°lido', 'Digite o n√∫mero correto com DDD.', 'error');
            if (!doc) return Swal.fire('Documento', 'Anexe o atestado de antecedentes.', 'warning');
            if (!terms) return Swal.fire('Termos', 'Voc√™ precisa aceitar os termos.', 'warning');

            // Salva como PENDENTE
            db.ref('users/' + user.uid).set({
                uid: user.uid, role: 'provider', name: nome, email: user.email, 
                phone: zap.replace(/\D/g,''), vehicle: type, status: 'pending', rating: 5.0
            }).then(() => location.reload());
        }

        // --- 3. APP (MAPA E FLUXO) ---
        function initMap() {
            if(!map) { 
                map = L.map('map', {zoomControl: false}).setView([-21.135, -44.261], 15);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            }
            document.getElementById('app-ui').style.display = 'block';
            
            // Geolocaliza√ß√£o Real
            watchId = navigator.geolocation.watchPosition(p => {
                const lat = p.coords.latitude; const lng = p.coords.longitude;
                // Atualiza posi√ß√£o no banco para os outros verem
                db.ref('locations/' + user.uid).set({ lat, lng, role, vehicle: (role==='provider' ? user.vehicle : 'user') });
                
                // Atualiza meu pino
                if(myMarker) map.removeLayer(myMarker);
                myMarker = L.marker([lat, lng]).addTo(map);
                map.setView([lat, lng], 16);
            }, null, {enableHighAccuracy:true});

            // Escuta movimenta√ß√£o dos outros
            db.ref('locations').on('value', snap => {
                // (Aqui entraria l√≥gica para limpar e redesenhar √≠cones dos outros usu√°rios)
                // Simplificado para este exemplo:
                // ... c√≥digo de renderizar √≠cones ...
            });
        }

        function iniciarAppUser(data) {
            user = data; role = 'passenger';
            showScreen('app-ui');
            document.getElementById('dock-user').classList.remove('hidden');
            initMap();
        }

        function iniciarAppProvider(data) {
            user = data; role = 'provider';
            showScreen('app-ui');
            document.getElementById('dock-provider').classList.remove('hidden');
            initMap();
            escutarPedidosProvider();
        }

        // --- 4. FLUXO DE PEDIDO (USU√ÅRIO) ---
        async function novoPedidoUI() {
            const { value: form } = await Swal.fire({
                title: 'Solicitar Servi√ßo',
                html: `
                    <select id="srv-cat" class="inp">
                        <option value="bike">üö≤ Bike / Eco</option>
                        <option value="moto">üèçÔ∏è Moto / R√°pido</option>
                        <option value="carro">üöó Carro / Conforto</option>
                        <option value="ape">üëü Office Boy</option>
                    </select>
                    <input id="srv-desc" class="inp" placeholder="O que precisa? (Ex: Levar chave)">
                    <input id="srv-val" class="inp" type="number" placeholder="Valor que oferece (R$)">
                `,
                confirmButtonText: 'ENVIAR PARA CATEGORIA',
                focusConfirm: false,
                preConfirm: () => [
                    document.getElementById('srv-cat').value,
                    document.getElementById('srv-desc').value,
                    document.getElementById('srv-val').value
                ]
            });

            if (form && form[1] && form[2]) {
                const oid = Date.now();
                db.ref('offers/' + oid).set({
                    id: oid, uid: user.uid, name: user.name, rating: user.rating,
                    category: form[0], desc: form[1], val: form[2], 
                    status: 'open', lat: 0, lng: 0 // Simplificado
                });
                Swal.fire('Enviado!', 'Aguardando prestador...', 'success');
                // Escuta aceites
                db.ref('offers/'+oid).on('value', snap => {
                    if(snap.val() && snap.val().status === 'accepted') {
                        audioBeep.play();
                        Swal.fire('ACEITO!', 'Prestador aceitou. Verifique o WhatsApp.', 'success');
                    }
                });
            }
        }

        // --- 5. FLUXO DE PEDIDO (PRESTADOR) ---
        function escutarPedidosProvider() {
            db.ref('offers').orderByChild('status').equalTo('open').on('value', snap => {
                const lista = document.getElementById('lista-ofertas');
                lista.innerHTML = '';
                let temPedido = false;

                snap.forEach(item => {
                    const o = item.val();
                    // Filtra: S√≥ mostra se a categoria bater com meu ve√≠culo
                    if (o.category === user.vehicle) {
                        temPedido = true;
                        audioBeep.play().catch(()=>{});
                        const div = document.createElement('div');
                        div.className = 'offer-card';
                        div.innerHTML = `
                            <div style="display:flex; justify-content:space-between;">
                                <b>${o.name} <i class="fas fa-star rating-star"></i>${o.rating}</b>
                                <span style="background:var(--eco); color:white; padding:2px 8px; borderRadius:10px;">R$ ${o.val}</span>
                            </div>
                            <p>${o.desc}</p>
                            <button class="btn btn-eco" onclick="aceitarPedido('${o.id}', '${o.uid}')">ACEITAR</button>
                        `;
                        lista.appendChild(div);
                    }
                });
                if(!temPedido) lista.innerHTML = '<p style="text-align:center; color:#94a3b8;">Nenhum pedido para seu ve√≠culo agora.</p>';
            });
        }

        async function aceitarPedido(oid, userId) {
            // Pega telefone do usu√°rio
            const snap = await db.ref('users/'+userId).get();
            const userPhone = snap.val().phone || ''; // Deveria ter pedido no cadastro de usu√°rio, simplificado aqui

            // Atualiza status e abre Zap
            db.ref('offers/'+oid).update({ status: 'accepted', providerId: user.uid });
            
            // Abre Whatsapp (Simula√ß√£o, pois user precisa ter zap cadastrado)
            // Se o usu√°rio logou com Google, n√£o temos o zap dele garantido, a menos que pe√ßamos.
            // Assumindo que temos:
            Swal.fire('Aceito!', 'Abrindo conversa...', 'success');
            // window.open(`https://wa.me/55${userPhone}`, '_blank'); 
        }

        // --- EXTRAS ---
        function verTermos() {
            Swal.fire({
                title: 'Termos e Isen√ß√£o',
                html: '<div style="text-align:justify; font-size:0.8rem; height:200px; overflow-y:scroll;">1. A Rota Direta √© apenas intermediadora.<br>2. N√£o nos responsabilizamos por pagamentos.<br>3. O uso indevido gera banimento.<br>4. Pagamentos s√£o P2P (Pessoa para Pessoa).</div>'
            });
        }
        function logout() { auth.signOut().then(() => location.reload()); }
        function sos() { window.open('tel:190'); }
        function compartilhar() { 
            if(navigator.share) navigator.share({title:'Rota Direta', text:'Baixe o App Sustent√°vel!', url:window.location.href});
        }
        
        // Simula√ß√£o Admin (Dev)
        function simularAprovacao() {
            db.ref('users/' + user.uid).update({ status: 'approved' }).then(() => location.reload());
        }
    </script>
</body>
</html>
