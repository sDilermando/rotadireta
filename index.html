<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rota Direta</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- ESTILO "STARTUP UNICORNIO" --- */
        :root { --bg:#f0f2f5; --surface:#fff; --dark:#1e1e2d; --gold:#ffcc00; --green:#00c853; --red:#ff3b30; --blue:#007aff; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; width: 100%; height: 100vh; background: var(--bg); font-family: 'Montserrat', sans-serif; overflow: hidden; display: flex; flex-direction: column; }

        /* LOADING */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--surface); z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: #888; font-weight: 600; }

        /* SPLASH SCREEN (CADASTRO) */
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--surface); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .logo { font-size: 2.5rem; font-weight: 900; color: var(--dark); margin-bottom: 30px; letter-spacing: -1px; }
        .logo span { color: var(--gold); }
        .btn-start { width: 100%; max-width: 320px; padding: 18px; margin: 10px 0; border: none; border-radius: 12px; font-size: 1rem; font-weight: 800; cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-start:active { transform: scale(0.97); }
        .b-dark { background: var(--dark); color: #fff; }
        .b-light { background: #fff; color: var(--dark); border: 2px solid var(--dark); }

        /* INTERFACE APP */
        #app-ui { display: none; flex: 1; position: relative; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* DISCLAIMER TOPO */
        .legal-bar { position: absolute; top: 0; left: 0; width: 100%; background: rgba(30,30,45,0.9); color: #ccc; font-size: 0.55rem; padding: 5px; text-align: center; z-index: 2000; backdrop-filter: blur(4px); }

        /* BARRA LATERAL (COMPARTILHAR) */
        .side-bar { position: absolute; top: 100px; right: 15px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .btn-icon { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--surface); box-shadow: 0 2px 10px rgba(0,0,0,0.2); color: var(--dark); font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-icon:active { transform: scale(0.9); }
        .btn-locate { color: var(--blue); }
        .btn-share { color: var(--dark); }
        .btn-panic { background: var(--red); color: white; animation: pulse 2s infinite; border: 2px solid white; }

        /* STATUS MOTORISTA (RODAP√â) */
        .driver-dock { position: absolute; bottom: 30px; left: 20px; right: 20px; background: var(--surface); padding: 15px; border-radius: 16px; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: none; text-align: center; }
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-action { padding: 15px; border-radius: 10px; border: none; font-weight: 800; font-size: 0.9rem; cursor: pointer; text-transform: uppercase; }
        .s-online { background: var(--green); color: white; }
        .s-busy { background: var(--gold); color: black; }
        .s-offline { background: #eee; color: #777; }
        
        /* BOT√ÉO DE RESET (VOLTAR A FICAR LIVRE) */
        .btn-reset { width: 100%; margin-top: 10px; padding: 12px; background: var(--blue); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; display: none; }

        /* PIN (MARCADOR NO MAPA) */
        .pin-wrap { position: relative; width: 60px; height: 60px; }
        .pin-label { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background: var(--green); color: white; font-size: 0.6rem; font-weight: 900; padding: 4px 8px; border-radius: 6px; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.2); text-transform: uppercase; }
        .pin-car { width: 50px; height: 50px; background-image: url('https://cdn-icons-png.flaticon.com/512/3202/3202926.png'); background-size: contain; background-repeat: no-repeat; background-position: center; margin: 0 auto; filter: drop-shadow(0 4px 3px rgba(0,0,0,0.3)); }
        
        /* ESTADOS DO PIN */
        .status-occupied .pin-label { background: var(--gold); color: black; }
        .status-occupied .pin-car { filter: grayscale(100%); }
        .status-alert .pin-label { background: var(--red); animation: blink 0.5s infinite; }
        .status-alert .pin-car { filter: sepia(1) hue-rotate(-50deg) saturate(5); } /* Fica Vermelho */

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 59, 48, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } }
        @keyframes blink { 50% { opacity: 0; } }

    </style>
</head>
<body>

    <div class="legal-bar">
        O Rota Direta √© uma plataforma de conex√£o. N√£o nos responsabilizamos por corridas, objetos perdidos ou conduta de usu√°rios. Uso por conta e risco. ¬© Gemini Tech
    </div>

    <div id="loading"><i class="fas fa-satellite-dish fa-spin fa-2x"></i><br><br>Iniciando Sistema...</div>

    <div id="splash">
        <div class="logo">ROTA <span>DIRETA</span></div>
        <p style="color:#666; font-size:0.9rem; margin-bottom:30px; max-width:300px;">Mobilidade Urbana Inteligente.<br>Conectando voc√™ ao seu destino.</p>
        
        <button class="btn-start b-dark" onclick="cadastrarMotorista()">
            <i class="fas fa-car"></i> SOU MOTORISTA
        </button>
        <button class="btn-start b-light" onclick="cadastrarPassageiro()">
            <i class="fas fa-user"></i> SOU PASSAGEIRO
        </button>
        
        <div style="margin-top:40px; font-size:0.7rem; color:#aaa;">
            Ao continuar, voc√™ concorda com nossos Termos de Uso.<br>
            <span onclick="resetarApp()" style="text-decoration:underline; cursor:pointer;">Resetar / Sair</span>
        </div>
    </div>

    <div id="app-ui">
        
        <div class="side-bar">
            <button class="btn-icon btn-share" onclick="compartilharApp()"><i class="fas fa-share-alt"></i></button>
            <button class="btn-icon btn-locate" onclick="meuLocal()"><i class="fas fa-crosshairs"></i></button>
            <button class="btn-icon btn-panic" onclick="acionarPanico()"><i class="fas fa-exclamation-triangle"></i></button>
        </div>

        <div id="map"></div>

        <div class="driver-dock" id="driverDock">
            <div class="status-grid">
                <button id="btnOnline" class="btn-action s-offline" onclick="toggleOnline()">Ficar Online</button>
                <div style="font-size:0.7rem; color:#555; display:flex; align-items:center; justify-content:center;">
                    Status: <b id="txtStatus" style="margin-left:5px;">OFFLINE</b>
                </div>
            </div>
            <button id="btnLiberar" class="btn-reset" onclick="liberarCarro()">
                <i class="fas fa-check"></i> FINALIZAR CORRIDA (FICAR LIVRE)
            </button>
        </div>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- 1. CONFIGURA√á√ÉO (FIREBASE) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBxbRiYNuGde5nwJIaoeRItWdZGR221cpY",
            authDomain: "rota-direta.firebaseapp.com",
            projectId: "rota-direta",
            storageBucket: "rota-direta.firebasestorage.app",
            messagingSenderId: "468273971962",
            appId: "1:468273971962:web:f536de2e2aa74f84dfff43",
            databaseURL: "https://rota-direta-default-rtdb.firebaseio.com"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e) {}
        const db = firebase.database();
        const auth = firebase.auth();

        // --- 2. VARI√ÅVEIS GLOBAIS ---
        let map, currentUser, userType, isOnline = false, watchId, markers = {};
        let myLat = -23.55, myLng = -46.63;
        let inactivityTimer;

        // --- 3. TERMOS DE USO (JUR√çDICO) ---
        const TERMOS_LEGAIS = `
            <div style="text-align:left; font-size:0.8rem; height:200px; overflow-y:scroll; border:1px solid #eee; padding:10px;">
                <strong>TERMOS DE USO E ISEN√á√ÉO DE RESPONSABILIDADE</strong><br><br>
                1. <strong>INTERMEDIA√á√ÉO:</strong> O "Rota Direta" √© apenas uma ferramenta tecnol√≥gica de conex√£o. N√£o somos uma empresa de transporte.<br>
                2. <strong>RESPONSABILIDADE:</strong> O Usu√°rio (Motorista e Passageiro) √© o √∫nico respons√°vel por seus atos, seguran√ßa, dados fornecidos e cumprimento das leis de tr√¢nsito.<br>
                3. <strong>ISEN√á√ÉO:</strong> O desenvolvedor (Gemini Tech) se isenta de qualquer responsabilidade civil ou criminal sobre danos, furtos, acidentes ou desentendimentos ocorridos atrav√©s do uso do app.<br>
                4. <strong>DADOS:</strong> Voc√™ garante que as informa√ß√µes fornecidas (Placa, Telefone, Nome) s√£o verdadeiras.<br><br>
                Ao clicar em "CONCORDO", voc√™ aceita estes termos irrestritamente.
            </div>
            <div style="margin-top:10px; display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="checkTermos"> <label for="checkTermos" style="font-size:0.9rem;">Li e Concordo</label>
            </div>
        `;

        // --- 4. INICIALIZA√á√ÉO ---
        window.onload = () => {
            auth.signInAnonymously().then(() => {
                document.getElementById('loading').style.display = 'none';
                verificarCache();
            });
            resetTimer();
            document.onclick = resetTimer; // Monitora atividade
        };

        function verificarCache() {
            // Verifica se j√° tem cadastro
            const drv = localStorage.getItem('rd_driver_v5');
            const pas = localStorage.getItem('rd_pass_v5');

            if (drv) iniciarApp('driver', JSON.parse(drv));
            else if (pas) iniciarApp('passenger', JSON.parse(pas));
            else document.getElementById('splash').style.display = 'flex';
        }

        // --- 5. CADASTROS (COM VALIDA√á√ÉO) ---
        async function cadastrarMotorista() {
            const { value: accept } = await Swal.fire({
                title: 'Termos de Uso', html: TERMOS_LEGAIS, confirmButtonText: 'ENVIAR', confirmButtonColor: '#222',
                preConfirm: () => {
                    if(!document.getElementById('checkTermos').checked) return Swal.showValidationMessage('Voc√™ precisa concordar com os termos.');
                }
            });

            if(accept) {
                // Formul√°rio Motorista
                const { value: form } = await Swal.fire({
                    title: 'Cadastro Profissional',
                    html: `
                        <input id="mNome" class="swal2-input" placeholder="Nome Completo">
                        <input id="mCarro" class="swal2-input" placeholder="Modelo do Carro (ex: Gol Branco)">
                        <input id="mPlaca" class="swal2-input" placeholder="Placa (ABC-1234)" style="text-transform:uppercase" maxlength="8">
                        <input id="mZap" class="swal2-input" type="tel" placeholder="WhatsApp (com DDD)">
                    `,
                    confirmButtonText: 'CONFIRMAR', confirmButtonColor: '#00c853',
                    preConfirm: () => {
                        const nome = document.getElementById('mNome').value;
                        const carro = document.getElementById('mCarro').value;
                        const placa = document.getElementById('mPlaca').value.toUpperCase();
                        const zap = document.getElementById('mZap').value.replace(/\D/g,'');

                        if(!nome || !carro || placa.length < 7 || zap.length < 10) return Swal.showValidationMessage('Preencha tudo corretamente!');
                        return { uid: auth.currentUser.uid, nome, carro, placa, zap, status: 'livre', type: 'driver' };
                    }
                });

                if(form) {
                    localStorage.setItem('rd_driver_v5', JSON.stringify(form));
                    db.ref('drivers/'+form.uid).set(form);
                    Swal.fire('Bem-vindo!', 'Cadastro realizado com sucesso.', 'success').then(() => iniciarApp('driver', form));
                }
            }
        }

        async function cadastrarPassageiro() {
            const { value: accept } = await Swal.fire({
                title: 'Termos de Uso', html: TERMOS_LEGAIS, confirmButtonText: 'ENVIAR', confirmButtonColor: '#222',
                preConfirm: () => { if(!document.getElementById('checkTermos').checked) return Swal.showValidationMessage('Aceite os termos.'); }
            });

            if(accept) {
                const { value: nome } = await Swal.fire({
                    title: 'Identifica√ß√£o', input: 'text', inputPlaceholder: 'Seu Nome', confirmButtonText: 'ENTRAR', confirmButtonColor: '#007aff'
                });
                if(nome) {
                    const form = { uid: auth.currentUser.uid, nome, type: 'passenger' };
                    localStorage.setItem('rd_pass_v5', JSON.stringify(form));
                    iniciarApp('passenger', form);
                }
            }
        }

        // --- 6. SISTEMA PRINCIPAL ---
        function iniciarApp(type, data) {
            userType = type;
            currentUser = data;
            document.getElementById('splash').style.display = 'none';
            document.getElementById('app-ui').style.display = 'flex';
            
            if(type === 'driver') document.getElementById('driverDock').style.display = 'block';
            
            initMap();
        }

        function initMap() {
            if(!map) {
                map = L.map('map', { zoomControl: false }).setView([-23.55, -46.63], 15);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            }
            meuLocal();
            escutarOnline();
        }

        // --- 7. L√ìGICA DO MOTORISTA (ONLINE/STATUS) ---
        function toggleOnline() {
            const btn = document.getElementById('btnOnline');
            const txt = document.getElementById('txtStatus');

            if(!isOnline) {
                if(!navigator.geolocation) return Swal.fire('Erro', 'Ative o GPS!', 'error');
                
                isOnline = true;
                btn.className = 'btn-action s-online';
                btn.innerText = 'VOC√ä EST√Å VIS√çVEL';
                txt.innerText = 'LIVRE';
                txt.style.color = 'var(--green)';
                
                // Salva no banco e atualiza posi√ß√£o
                db.ref('online/'+currentUser.uid).set({...currentUser, status: 'livre'});
                db.ref('online/'+currentUser.uid).onDisconnect().remove(); // Remove se cair a net

                watchId = navigator.geolocation.watchPosition(pos => {
                    const lat = pos.coords.latitude; const lng = pos.coords.longitude;
                    db.ref('online/'+currentUser.uid).update({ lat, lng });
                }, null, { enableHighAccuracy: true });

            } else {
                goOffline();
            }
        }

        function goOffline() {
            isOnline = false;
            const btn = document.getElementById('btnOnline');
            const txt = document.getElementById('txtStatus');
            
            btn.className = 'btn-action s-offline';
            btn.innerText = 'FICAR ONLINE';
            txt.innerText = 'OFFLINE';
            txt.style.color = '#777';
            
            if(watchId) navigator.geolocation.clearWatch(watchId);
            db.ref('online/'+currentUser.uid).remove();
        }

        function liberarCarro() {
            if(!isOnline) return;
            db.ref('online/'+currentUser.uid).update({ status: 'livre' });
            document.getElementById('btnLiberar').style.display = 'none';
            document.getElementById('txtStatus').innerText = 'LIVRE';
            Swal.fire('Pronto', 'Voc√™ est√° livre para novas corridas.', 'success');
        }

        // --- 8. ESCUTA EM TEMPO REAL (CORA√á√ÉO DO APP) ---
        function escutarOnline() {
            db.ref('online').on('value', snap => {
                const list = snap.val() || {};
                
                // Limpa quem saiu
                for(let uid in markers) { if(!list[uid]) { map.removeLayer(markers[uid]); delete markers[uid]; } }

                for(let uid in list) {
                    if(uid === currentUser.uid) continue; // N√£o mostra a si mesmo

                    const d = list[uid];
                    let cssClass = '';
                    let labelText = 'LIVRE';

                    // L√ìGICA DE STATUS
                    if(d.status === 'ocupado') { cssClass = 'status-occupied'; labelText = 'OCUPADO'; }
                    if(d.status === 'alerta') { cssClass = 'status-alert'; labelText = 'ALERTA!'; tocarSirene(); }

                    const html = `
                        <div class="pin-wrap ${cssClass}">
                            <div class="pin-label">${labelText}</div>
                            <div class="pin-car"></div>
                        </div>`;
                    
                    const icon = L.divIcon({ className: 'custom-pin', html: html, iconSize: [60, 60], iconAnchor: [30, 30] });

                    if(markers[uid]) {
                        markers[uid].setLatLng([d.lat, d.lng]);
                        markers[uid].setIcon(icon);
                    } else {
                        const m = L.marker([d.lat, d.lng], {icon}).addTo(map);
                        m.on('click', () => interagirMotorista(d));
                        markers[uid] = m;
                    }
                }
            });
        }

        // --- 9. INTERA√á√ÉO PASSAGEIRO -> MOTORISTA ---
        function interagirMotorista(d) {
            if(d.status === 'ocupado') return Swal.fire('Ocupado', 'Este motorista est√° em corrida.', 'info');
            if(d.status === 'alerta') return Swal.fire('PERIGO', 'Este ve√≠culo sinalizou emerg√™ncia!', 'warning');

            Swal.fire({
                title: d.nome,
                html: `
                    <div style="text-align:left; font-size:0.9rem;">
                        üöò <b>Carro:</b> ${d.carro}<br>
                        üî° <b>Placa:</b> ${d.placa}<br>
                        ‚≠ê <b>Status:</b> ${d.status.toUpperCase()}
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'CHAMAR (WhatsApp)',
                confirmButtonColor: '#25D366'
            }).then((res) => {
                if(res.isConfirmed) {
                    // Passageiro chama -> Carro fica ocupado
                    db.ref('online/'+d.uid).update({ status: 'ocupado' });
                    window.open(`https://wa.me/55${d.zap}?text=Ol√°, sou ${currentUser.nome}, vi voc√™ no Rota Direta. Pode me buscar?`, '_blank');
                }
            });
        }

        // --- 10. FUNCIONALIDADES EXTRAS ---
        
        // P√¢nico (Funciona pra todos)
        function acionarPanico() {
            Swal.fire({
                title: 'ACIONAR ALERTA?',
                text: "Isso deixar√° seu √≠cone VERMELHO para todos e tocar√° um alarme.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'SIM, SOCORRO!'
            }).then((result) => {
                if (result.isConfirmed) {
                    if(!isOnline && userType === 'driver') toggleOnline(); // Fica online for√ßado se for motorista
                    
                    // Se for passageiro, cria um marcador tempor√°rio de alerta
                    if(userType === 'passenger') {
                         navigator.geolocation.getCurrentPosition(pos => {
                             db.ref('online/'+currentUser.uid).set({
                                 uid: currentUser.uid, nome: currentUser.nome, lat: pos.coords.latitude, lng: pos.coords.longitude, status: 'alerta', carro: 'PASSAGEIRO', placa: 'SOS'
                             });
                         });
                    } else {
                        db.ref('online/'+currentUser.uid).update({ status: 'alerta' });
                    }
                    Swal.fire('ALERTA ENVIADO', '', 'success');
                }
            });
        }

        // √Åudio (Bip)
        function tocarSirene() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(800, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, ctx.currentTime + 0.5);
            osc.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 0.5);
        }

        // Localiza√ß√£o
        function meuLocal() {
            navigator.geolocation.getCurrentPosition(pos => {
                map.setView([pos.coords.latitude, pos.coords.longitude], 16);
                // Bolinha azul
                L.circleMarker([pos.coords.latitude, pos.coords.longitude], {radius: 8, color: 'white', fillColor: '#007aff', fillOpacity: 1}).addTo(map);
            });
        }

        // Compartilhar
        function compartilharApp() {
            if (navigator.share) {
                navigator.share({
                    title: 'Rota Direta',
                    text: 'Baixe o melhor app de mobilidade!',
                    url: window.location.href
                });
            } else {
                Swal.fire('Link copiado!', window.location.href, 'success');
            }
        }

        // Timer de Inatividade (10 min)
        function resetTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                if(isOnline) {
                    goOffline();
                    Swal.fire('Sess√£o Expirada', 'Voc√™ ficou 10min inativo e foi desconectado.', 'warning');
                }
            }, 10 * 60 * 1000); // 10 minutos
        }
        
        function resetarApp() {
            if(confirm('Isso apagar√° seu cadastro. Continuar?')) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>
</body>
</html>
