<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rota Direta 11.0</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- ESTILO --- */
        :root { --bg:#f4f4f9; --dark:#1a1a2e; --gold:#ffcc00; --green:#00c853; --red:#ff3b30; --blue:#2979ff; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; width: 100%; height: 100vh; background: var(--bg); font-family: 'Montserrat', sans-serif; overflow: hidden; display: flex; flex-direction: column; }

        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 20000; display: flex; justify-content: center; align-items: center; color: #888; font-weight: bold; flex-direction: column; }

        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; transition: 0.3s; }
        .hidden { display: none !important; }

        .logo { font-size: 2.5rem; font-weight: 900; color: var(--dark); margin-bottom: 30px; }
        .logo span { color: var(--gold); }

        .btn-big { width: 100%; max-width: 300px; padding: 18px; margin-bottom: 15px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .b-drv { background: var(--dark); color: white; }
        .b-pas { background: white; color: var(--dark); border: 2px solid var(--dark); }

        .modal-form { background: white; padding: 25px; border-radius: 20px; width: 100%; max-width: 340px; box-shadow: 0 15px 50px rgba(0,0,0,0.3); text-align: center; }
        .inp { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; background: #f9f9f9; }
        .btn-confirm { width: 100%; padding: 14px; background: var(--green); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 1rem; }
        .btn-cancel { background: none; border: none; text-decoration: underline; color: #888; margin-top: 15px; cursor: pointer; }

        #app-ui { display: none; flex: 1; position: relative; z-index: 1; }
        #map { width: 100%; height: 100%; }

        /* BOTÕES LATERAIS (PEQUENOS E BAIXOS) */
        .side-bar { position: absolute; bottom: 100px; right: 10px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
        .btn-icon { width: 35px; height: 35px; border-radius: 50%; border: none; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--dark); }
        .btn-panic { background: var(--red); color: white; animation: pulse 1s infinite; }

        .driver-dock { position: absolute; bottom: 20px; left: 20px; right: 20px; background: white; padding: 15px; border-radius: 15px; z-index: 2000; text-align: center; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .btn-status { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 800; font-size: 0.9rem; text-transform: uppercase; cursor: pointer; transition: 0.3s; }
        .s-off { background: #eee; color: #777; }
        .s-on { background: var(--green); color: white; }

        /* --- NOVOS TAMANHOS DE ÍCONES --- */
        
        /* CARRO: 30px */
        .pin-wrap { position: relative; width: 30px; height: 30px; }
        .pin-label { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--green); color: white; font-size: 0.4rem; font-weight: 900; padding: 1px 3px; border-radius: 3px; white-space: nowrap; }
        .pin-car { width: 100%; height: 100%; background-image: url('https://cdn-icons-png.flaticon.com/512/3202/3202926.png'); background-size: contain; background-repeat: no-repeat; margin: 0 auto; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        
        /* PASSAGEIRO: 20px */
        .me-wrap { position: relative; width: 20px; height: 20px; display:flex; justify-content:center; }
        .me-label { position: absolute; top: -12px; background: var(--blue); color: white; font-size: 0.5rem; font-weight: bold; padding: 1px 3px; border-radius: 3px; white-space: nowrap; }
        .me-icon { font-size: 1.2rem; color: var(--blue); text-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        /* STATUS */
        .status-ocupado .pin-label { background: var(--gold); color: black; }
        .status-ocupado .pin-car { filter: grayscale(1) opacity(0.5); }
        .status-alerta .pin-label { background: var(--red); }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="loading"><i class="fas fa-satellite-dish fa-spin fa-2x"></i></div>

    <div id="screen-splash" class="screen">
        <div class="logo">ROTA <span>DIRETA</span></div>
        <button class="btn-big b-drv" onclick="irParaLoginMotorista()"><i class="fas fa-car"></i> SOU MOTORISTA</button>
        <button class="btn-big b-pas" onclick="irParaLoginPassageiro()"><i class="fas fa-user"></i> SOU PASSAGEIRO</button>
        <div style="margin-top:20px; font-size:0.7rem; color:#aaa;">Versão 11.0</div>
        <button onclick="resetarTudo()" style="margin-top:20px; border:1px solid red; color:red; background:white; padding:5px 10px; border-radius:5px; font-size:0.7rem; cursor:pointer;">ESQUECI O PIN / RESETAR</button>
    </div>

    <div id="screen-login-mot" class="screen hidden" style="background:rgba(0,0,0,0.8);">
        <div class="modal-form">
            <h3>Bem-vindo</h3>
            <p id="nome-motorista-volta" style="font-weight:bold;">...</p>
            <input type="number" id="login-pin" class="inp" placeholder="PIN" style="text-align:center; font-size:1.5rem; letter-spacing:5px;">
            <button class="btn-confirm" onclick="validarSenha()">ENTRAR</button>
            <button class="btn-cancel" onclick="voltarInicio()">Cancelar</button>
        </div>
    </div>

    <div id="screen-cad-mot" class="screen hidden" style="overflow-y:auto;">
        <div class="modal-form">
            <h3>Novo Motorista</h3>
            <input id="c-nome" class="inp" placeholder="Nome Completo">
            <input id="c-carro" class="inp" placeholder="Carro (Modelo/Cor)">
            <input id="c-placa" class="inp" placeholder="Placa" style="text-transform:uppercase">
            <input id="c-zap" class="inp" type="tel" placeholder="WhatsApp">
            <input id="c-email" class="inp" type="email" placeholder="E-mail">
            <button class="btn-confirm" onclick="finalizarCadastroMot()">CADASTRAR</button>
            <button class="btn-cancel" onclick="voltarInicio()">Cancelar</button>
        </div>
    </div>

    <div id="screen-cad-pas" class="screen hidden">
        <div class="modal-form">
            <h3>Passageiro</h3>
            <input id="cp-nome" class="inp" placeholder="Seu Nome">
            <input id="cp-zap" class="inp" type="tel" placeholder="Seu WhatsApp">
            <button class="btn-confirm" onclick="finalizarCadastroPas()">ENTRAR</button>
            <button class="btn-cancel" onclick="voltarInicio()">Cancelar</button>
        </div>
    </div>

    <div id="app-ui">
        <div class="side-bar">
            <button class="btn-icon" onclick="compartilhar()"><i class="fas fa-share-alt"></i></button>
            <button class="btn-icon" onclick="meuLocal(true)"><i class="fas fa-crosshairs"></i></button>
            <button class="btn-icon btn-panic" onclick="panico()"><i class="fas fa-exclamation-triangle"></i></button>
            <button class="btn-icon" onclick="location.reload()" style="color:var(--red)"><i class="fas fa-power-off"></i></button>
        </div>

        <div id="map"></div>

        <div class="driver-dock" id="driverDock">
            <button id="btnOnline" class="btn-status s-off" onclick="toggleOnline()">FICAR ONLINE</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        window.onerror = function(msg) { alert("Erro: " + msg); };

        const firebaseConfig = {
            apiKey: "AIzaSyBxbRiYNuGde5nwJIaoeRItWdZGR221cpY",
            authDomain: "rota-direta.firebaseapp.com",
            projectId: "rota-direta",
            storageBucket: "rota-direta.firebasestorage.app",
            messagingSenderId: "468273971962",
            appId: "1:468273971962:web:f536de2e2aa74f84dfff43",
            databaseURL: "https://rota-direta-default-rtdb.firebaseio.com"
        };

        let db, auth, map, currentUser, userType, isOnline = false, watchId, markers = {};
        let myLat = -23.55, myLng = -46.63;
        let simInterval;

        window.onload = function() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                auth = firebase.auth();
                auth.signInAnonymously().then(() => {
                    document.getElementById('loading').style.display = 'none';
                }).catch(e => alert("Sem conexão"));
            } catch(e) {}
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
            document.getElementById('app-ui').style.display = 'none';
            if(id === 'app-ui') document.getElementById('app-ui').style.display = 'flex';
            else document.getElementById(id).classList.remove('hidden');
        }
        function voltarInicio() { showScreen('screen-splash'); }

        // --- CADASTROS ---
        function irParaLoginMotorista() {
            const salvo = localStorage.getItem('rd_drv_v11');
            if(salvo) {
                const dados = JSON.parse(salvo);
                document.getElementById('nome-motorista-volta').innerText = dados.nome;
                showScreen('screen-login-mot');
            } else showScreen('screen-cad-mot');
        }

        function finalizarCadastroMot() {
            const form = {
                uid: auth.currentUser.uid,
                pin: Math.floor(1000 + Math.random() * 9000),
                nome: document.getElementById('c-nome').value,
                carro: document.getElementById('c-carro').value,
                placa: document.getElementById('c-placa').value.toUpperCase(),
                zap: document.getElementById('c-zap').value.replace(/\D/g,''),
                email: document.getElementById('c-email').value,
                type: 'driver'
            };
            if(!form.nome || !form.placa) return alert("Preencha tudo!");
            localStorage.setItem('rd_drv_v11', JSON.stringify(form));
            db.ref('drivers/' + form.uid).set(form);
            alert("SUCESSO! SENHA: " + form.pin);
            entrarApp('driver', form);
        }

        function validarSenha() {
            const salvo = JSON.parse(localStorage.getItem('rd_drv_v11'));
            if(document.getElementById('login-pin').value == salvo.pin) entrarApp('driver', salvo);
            else alert("Senha errada");
        }

        function irParaLoginPassageiro() {
            const salvo = localStorage.getItem('rd_pas_v11');
            if(salvo) entrarApp('passenger', JSON.parse(salvo));
            else showScreen('screen-cad-pas');
        }

        function finalizarCadastroPas() {
            const form = { 
                uid: auth.currentUser.uid, 
                nome: document.getElementById('cp-nome').value, 
                zap: document.getElementById('cp-zap').value.replace(/\D/g,''), 
                type: 'passenger' 
            };
            if(!form.nome) return alert("Preencha o nome");
            localStorage.setItem('rd_pas_v11', JSON.stringify(form));
            entrarApp('passenger', form);
        }

        function resetarTudo() {
            if(confirm("Deseja apagar sua conta deste celular e criar uma nova?")) {
                localStorage.clear();
                location.reload();
            }
        }

        // --- APP ---
        function entrarApp(type, data) {
            userType = type;
            currentUser = data;
            showScreen('app-ui');
            if(type === 'driver') document.getElementById('driverDock').style.display = 'block';
            
            setTimeout(() => {
                initMap();
                iniciarSimulacao();
            }, 500);
        }

        function initMap() {
            if(!map) {
                map = L.map('map', { zoomControl: false }).setView([myLat, myLng], 15);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            }
            meuLocal(true);
            escutarOnline();
        }

        function toggleOnline() {
            const btn = document.getElementById('btnOnline');
            if(!isOnline) {
                if(!navigator.geolocation) return alert("Ligue o GPS");
                isOnline = true;
                btn.className = 'btn-status s-on';
                btn.innerText = 'VOCÊ ESTÁ VISÍVEL';
                
                watchId = navigator.geolocation.watchPosition(pos => {
                    myLat = pos.coords.latitude;
                    myLng = pos.coords.longitude;
                    
                    // AGORA SEU CARRO TAMBÉM É ENVIADO PARA O MAPA LOCAL
                    db.ref('online/'+currentUser.uid).set({
                        ...currentUser, lat: myLat, lng: myLng, status: 'livre', last: Date.now()
                    });
                    
                    // Garante que o mapa centralize na primeira vez
                    if(!markers[currentUser.uid]) map.setView([myLat, myLng], 17);

                }, null, {enableHighAccuracy: true});
            } else {
                isOnline = false;
                btn.className = 'btn-status s-off';
                btn.innerText = 'FICAR ONLINE';
                if(watchId) navigator.geolocation.clearWatch(watchId);
                db.ref('online/'+currentUser.uid).remove();
            }
        }

        function escutarOnline() {
            db.ref('online').on('value', snap => {
                const list = snap.val() || {};
                
                for(let uid in markers) { if(!list[uid]) { map.removeLayer(markers[uid]); delete markers[uid]; } }

                for(let uid in list) {
                    // SE SOU MOTORISTA, QUERO VER MEU CARRO TAMBÉM (REMOVIDO FILTRO)
                    const d = list[uid];
                    
                    let css = ''; let lbl = 'LIVRE';
                    if(d.status === 'ocupado') { css = 'status-ocupado'; lbl = 'OCUPADO'; }
                    if(d.status === 'alerta') { css = 'status-alerta'; lbl = 'ALERTA'; }

                    // Carro Pequeno (30px)
                    const html = `<div class="pin-wrap ${css}"><div class="pin-label">${lbl}</div><div class="pin-car"></div></div>`;
                    const icon = L.divIcon({ className: 'custom', html: html, iconSize: [30,30], iconAnchor:[15,15] });

                    if(markers[uid]) markers[uid].setLatLng([d.lat, d.lng]).setIcon(icon);
                    else {
                        const m = L.marker([d.lat, d.lng], {icon}).addTo(map);
                        m.on('click', () => {
                            if(userType === 'passenger') {
                                if(d.status === 'ocupado') return Swal.fire('Ocupado', 'Veículo em corrida.', 'info');
                                
                                Swal.fire({
                                    title: d.nome,
                                    text: `${d.carro}`,
                                    showCancelButton: true,
                                    confirmButtonText: 'CHAMAR WHATSAPP',
                                    confirmButtonColor: '#25D366',
                                    cancelButtonText: 'Voltar'
                                }).then((result) => {
                                    if(result.isConfirmed) {
                                        db.ref('online/'+d.uid).update({status: 'ocupado'});
                                        const msg = `Olá, sou ${currentUser.nome}. Chamei seu carro (${d.carro}).`;
                                        window.open(`https://wa.me/55${d.zap}?text=${encodeURIComponent(msg)}`, '_blank');
                                    }
                                });
                            }
                        });
                        markers[uid] = m;
                    }
                }
            });
        }

        function meuLocal(forceZoom = false) {
            navigator.geolocation.getCurrentPosition(p => {
                myLat = p.coords.latitude;
                myLng = p.coords.longitude;
                if(forceZoom) map.setView([myLat, myLng], 17);
                
                // DESENHA O BONEQUINHO PEQUENO (20px)
                map.eachLayer(l => { if(l.options.icon && l.options.icon.options.className === 'me-icon-class') map.removeLayer(l); });

                const html = `<div class="me-wrap"><div class="me-label">Eu</div><i class="fas fa-user me-icon"></i></div>`;
                const icon = L.divIcon({ className: 'me-icon-class', html: html, iconSize: [20,20], iconAnchor:[10,20] });
                L.marker([myLat, myLng], {icon}).addTo(map);
            });
        }

        // --- SIMULAÇÃO INTELIGENTE ---
        function iniciarSimulacao() {
            // Cria 3 bots
            const bots = [
                { id: 'bot_1', nome: 'Teste João', carro: 'Gol Branco', lat: myLat+0.001, lng: myLng+0.001, dir: 1, timer: 0 },
                { id: 'bot_2', nome: 'Teste Ana', carro: 'Fiat Uno', lat: myLat-0.001, lng: myLng-0.001, dir: -1, timer: 5 },
                { id: 'bot_3', nome: 'Teste Pedro', carro: 'Onix Prata', lat: myLat+0.001, lng: myLng-0.002, dir: 1, timer: 10 }
            ];

            if(simInterval) clearInterval(simInterval);
            simInterval = setInterval(() => {
                bots.forEach(b => {
                    // Movimento mais fluido
                    b.lat += (0.0001 * b.dir);
                    if(Math.random() > 0.95) b.dir *= -1; // Vira as vezes

                    // Lógica de Ocupado/Livre Automático
                    b.timer++;
                    let st = 'livre';
                    
                    // Fica livre por 15 ticks, ocupado por 5 ticks
                    if(b.timer > 15) st = 'ocupado';
                    if(b.timer > 20) b.timer = 0; // Reseta ciclo

                    db.ref('online/'+b.id).set({
                        uid: b.id, nome: b.nome, carro: b.carro, placa: 'TEST-000', zap: '00',
                        lat: b.lat, lng: b.lng, status: st
                    });
                });
            }, 1000); // Atualiza todo segundo (mais rápido)
        }

        function compartilhar() {
            if(navigator.share) navigator.share({title:'Rota Direta', url:window.location.href});
        }
        function panico() {
            if(confirm("ACIONAR PÂNICO?")) db.ref('online/'+currentUser.uid).update({status:'alerta'});
        }

    </script>
</body>
</html>
