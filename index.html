<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rota Direta Oficial</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --bg: #f8fafc; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; transition: 0.3s; overflow-y: auto; }
        .hidden { display: none !important; }
        
        .card { background: white; padding: 30px; border-radius: 24px; width: 100%; max-width: 360px; box-shadow: 0 20px 60px -10px rgba(0,0,0,0.15); }
        .logo { font-size: 2.2rem; font-weight: 900; color: var(--primary); margin-bottom: 20px; text-align: center; }
        .logo span { color: var(--accent); }
        
        .inp { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; margin-bottom: 10px; background: #f8fafc; box-sizing:border-box; outline:none; }
        .inp:focus { border-color: var(--accent); background: white; }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: 700; cursor: pointer; margin-top: 10px; color: white; display:flex; justify-content:center; align-items:center; gap:10px; transition:0.2s; text-decoration: none; font-size: 0.9rem; }
        .btn:active { transform:scale(0.98); }
        .btn-primary { background: var(--primary); }
        .btn-google { background: white; color: #333; border: 2px solid #e2e8f0; }
        .btn-success { background: var(--success); }
        .btn-warning { background: var(--warning); color: #fff; }
        .btn-outline { background: white; border: 2px solid #e2e8f0; color: var(--primary); }

        /* MAPA E UI */
        #app-ui { display: none; flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        
        /* BOT√ÉO FLUTUANTE PASSAGEIRO */
        #btn-ofertar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.3); z-index: 1000; cursor: pointer; display: none; align-items: center; gap: 10px; white-space: nowrap; }
        #btn-ofertar:active { transform: translateX(-50%) scale(0.95); }

        /* DOCK MOTORISTA */
        #driver-dock { position: absolute; bottom: 0; left: 0; right: 0; background: white; padding: 20px; border-radius: 24px 24px 0 0; z-index: 1000; display: none; box-shadow: 0 -10px 30px rgba(0,0,0,0.1); max-height: 50vh; overflow-y: auto; }
        
        .offer-card { background: #fffbeb; border: 2px solid #fcd34d; padding: 15px; border-radius: 12px; margin-bottom: 10px; animation: slideUp 0.3s ease; }
        .offer-card h4 { margin: 0 0 5px 0; color: #b45309; }
        .offer-card p { margin: 0 0 10px 0; font-size: 0.9rem; color: #78350f; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .pin-eu { width: 20px; height: 20px; background: var(--accent); border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .pin-car { width: 40px; height: 40px; background-image: url('https://cdn-icons-png.flaticon.com/512/3202/3202926.png'); background-size: contain; background-repeat: no-repeat; filter: drop-shadow(0 3px 2px rgba(0,0,0,0.3)); }
    </style>
</head>
<body>

    <div id="screen-splash" class="screen">
        <div class="logo">ROTA <span>DIRETA</span></div>
        <div class="card">
            <button class="btn btn-google" onclick="loginGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Passageiro (Entrar com Google)
            </button>
            <div style="text-align:center; margin:20px 0; font-size:0.8rem; color:#ccc; font-weight:bold;">√ÅREA DO PARCEIRO</div>
            <button class="btn btn-primary" onclick="showScreen('screen-login-mot')"><i class="fas fa-car"></i> Sou Motorista</button>
        </div>
        <div style="margin-top:30px; color:#94a3b8; font-size:0.7rem;">Vers√£o 19.0 (inDrive Mode)</div>
    </div>

    <div id="screen-login-mot" class="screen hidden">
        <div class="card">
            <h3 style="text-align:center; margin-top:0;">Login Motorista</h3>
            <input id="login-email" class="inp" type="email" placeholder="Seu E-mail">
            <input id="login-pass" class="inp" type="password" placeholder="Sua Senha">
            <button class="btn btn-primary" onclick="fazerLoginMotorista()">ACESSAR SISTEMA</button>
            <button class="btn btn-outline" onclick="showScreen('screen-register-mot')">CRIAR NOVA CONTA</button>
            <div onclick="recuperarSenha()" style="text-align:center; margin-top:15px; font-size:0.8rem; cursor:pointer; color:var(--accent);">Esqueci a Senha</div>
            <div onclick="showScreen('screen-splash')" style="text-align:center; margin-top:10px; font-size:0.8rem; cursor:pointer; color:#64748b;">Voltar</div>
        </div>
    </div>

    <div id="screen-register-mot" class="screen hidden">
        <div class="card">
            <h3 style="text-align:center; margin-top:0;">Novo Cadastro</h3>
            <p style="font-size:0.8rem; color:#64748b; text-align:center; margin-bottom:15px;">Preencha seus dados. Valida√ß√£o via WhatsApp.</p>
            <input id="m-nome" class="inp" placeholder="Nome Completo">
            <input id="m-email" class="inp" type="email" placeholder="E-mail V√°lido">
            <input id="m-pass" class="inp" type="password" placeholder="Crie uma Senha">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input id="m-placa" class="inp" placeholder="PLACA" style="text-transform:uppercase">
                <input id="m-zap" class="inp" type="tel" placeholder="WhatsApp">
            </div>
            <div style="margin-top:15px; font-size:0.8rem; display:flex; gap:5px;">
                <input type="checkbox" id="m-terms"><span>Concordo com os termos.</span>
            </div>
            <button class="btn btn-success" onclick="registrarMotorista()">CRIAR CONTA</button>
            <div onclick="showScreen('screen-login-mot')" style="text-align:center; margin-top:10px; cursor:pointer; color:#64748b;">Cancelar</div>
        </div>
    </div>

    <div id="app-ui">
        <div id="map"></div>
        
        <div style="position:absolute; top:20px; right:20px; z-index:1000;">
            <button onclick="location.reload()" style="background:white; border:none; padding:10px; border-radius:50%; box-shadow:0 4px 10px rgba(0,0,0,0.2); color:red;"><i class="fas fa-power-off"></i></button>
        </div>

        <button id="btn-ofertar" onclick="abrirOferta()">
            <i class="fas fa-bullhorn"></i> OFERTAR CORRIDA
        </button>

        <div id="driver-dock">
            <div id="dock-aprovado" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0;">Radar de Corridas</h3>
                    <button id="btn-status" class="btn btn-success" style="padding:8px 15px; width:auto; margin:0;" onclick="toggleOnline()">FICAR ONLINE</button>
                </div>
                <div id="lista-ofertas">
                    <p style="text-align:center; color:#94a3b8; font-size:0.9rem; padding:20px;">Nenhuma oferta no momento...</p>
                </div>
            </div>

            <div id="dock-pendente" class="hidden">
                <h3 style="margin:0 0 5px 0; color:var(--warning);">Cadastro em An√°lise</h3>
                <p style="font-size:0.8rem; color:#64748b; margin-bottom:15px;">Envie sua CNH para liberar o sistema.</p>
                <button class="btn btn-warning" onclick="abrirZapAdmin()">
                    <i class="fab fa-whatsapp"></i> FALAR COM SUPORTE
                </button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ïES
        const ZAP_ADMIN = "5532984099000"; // Seu n√∫mero (Dilermando)
        
        const firebaseConfig = { apiKey: "AIzaSyBxbRiYNuGde5nwJIaoeRItWdZGR221cpY", authDomain: "rota-direta.firebaseapp.com", projectId: "rota-direta", databaseURL: "https://rota-direta-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        let map, currentUser, isOnline=false, watchId, markers={};
        const audioAlert = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); // Som de notifica√ß√£o

        // UI & UTILS
        function showScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden')); document.getElementById('app-ui').style.display='none'; if(id==='app-ui') document.getElementById('app-ui').style.display='flex'; else document.getElementById(id).classList.remove('hidden'); }
        window.onload = () => { try{ IMask(document.getElementById('m-zap'),{mask:'(00) 00000-0000'}); }catch(e){} }

        // --- LOGIN PASSAGEIRO (PADR√ÉO GOOGLE) ---
        function loginGoogle(){ 
            auth.signInWithPopup(provider).then(r=>{ 
                const u=r.user; 
                const dados={uid:u.uid, nome:u.displayName, foto:u.photoURL, email:u.email, type:'passenger'};
                db.ref('passengers/'+u.uid).update(dados); 
                currentUser=dados; 
                entrarApp(); 
            }).catch(e=>Swal.fire('Erro',e.message,'error')); 
        }

        // --- MOTORISTA ---
        async function registrarMotorista() {
            if(!document.getElementById('m-terms').checked) return Swal.fire('Aten√ß√£o','Aceite os termos.','warning');
            const nome = document.getElementById('m-nome').value;
            const email = document.getElementById('m-email').value;
            const pass = document.getElementById('m-pass').value;
            const placa = document.getElementById('m-placa').value.toUpperCase();
            const zap = document.getElementById('m-zap').value.replace(/\D/g,'');

            try {
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                const pin = Math.floor(1000+Math.random()*9000);
                await db.ref('drivers/'+cred.user.uid).set({ uid: cred.user.uid, nome, email, placa, zap, pin, status: 'pendente', createdAt: Date.now() });
                Swal.fire('Conta Criada!','Fa√ßa login para validar.','success').then(()=> showScreen('screen-login-mot'));
            } catch(e) { Swal.fire('Erro', e.message, 'error'); }
        }

        async function fazerLoginMotorista() {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            auth.signInWithEmailAndPassword(email, pass).then(async (cred) => {
                const snap = await db.ref('drivers/'+cred.user.uid).get();
                if(snap.exists()){ currentUser = snap.val(); currentUser.type = 'driver'; entrarApp(); } 
                else Swal.fire('Erro','Motorista n√£o encontrado.','error');
            }).catch(e => Swal.fire('Erro', 'Dados incorretos.', 'error'));
        }

        function recuperarSenha() {
            const email = document.getElementById('login-email').value;
            if(!email) return Swal.fire('Info','Digite seu email acima.','info');
            auth.sendPasswordResetEmail(email).then(()=>Swal.fire('Sucesso','Verifique seu email.','success'));
        }

        // --- L√ìGICA DO APP ---
        function entrarApp() {
            showScreen('app-ui');
            
            // CONFIGURA TELA
            if(currentUser.type === 'driver') {
                document.getElementById('driver-dock').style.display = 'block';
                if(currentUser.status === 'aprovado') {
                    document.getElementById('dock-aprovado').classList.remove('hidden');
                    document.getElementById('dock-pendente').classList.add('hidden');
                    escutarOfertas(); // Motorista escuta pedidos
                } else {
                    document.getElementById('dock-aprovado').classList.add('hidden');
                    document.getElementById('dock-pendente').classList.remove('hidden');
                }
            } else {
                // √â Passageiro
                document.getElementById('driver-dock').style.display = 'none';
                document.getElementById('btn-ofertar').style.display = 'flex'; // Mostra bot√£o ofertar
                escutarCarros(); // Passageiro v√™ carros
            }

            // MAPA
            if(!map) { map = L.map('map',{zoomControl:false}).setView([-23.55,-46.63],15); L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map); }
            navigator.geolocation.getCurrentPosition(p=>{
                map.setView([p.coords.latitude, p.coords.longitude],17);
                const html = currentUser.foto ? `<img src="${currentUser.foto}" style="width:30px;height:30px;border-radius:50%;border:2px solid blue;">` : `<div class="pin-eu"></div>`;
                L.marker([p.coords.latitude, p.coords.longitude],{icon:L.divIcon({className:'eu',html:html})}).addTo(map);
            });
        }

        // --- PASSAGEIRO: SISTEMA DE OFERTAS ---
        async function abrirOferta() {
            const { value: formValues } = await Swal.fire({
                title: 'Nova Oferta',
                html:
                    '<input id="swal-destino" class="swal2-input" placeholder="Para onde voc√™ vai?">' +
                    '<input id="swal-valor" class="swal2-input" type="number" placeholder="Valor (R$)" style="width:100px; margin-top:10px;">',
                focusConfirm: false,
                confirmButtonText: 'LAN√áAR OFERTA üì¢',
                showCancelButton: true,
                preConfirm: () => {
                    return [
                        document.getElementById('swal-destino').value,
                        document.getElementById('swal-valor').value
                    ]
                }
            });

            if (formValues && formValues[0] && formValues[1]) {
                const offerId = Date.now(); // ID √∫nico
                const zap = currentUser.zap || ''; // Se tiver salvo, sen√£o vazio
                
                // Manda pro Mural
                await db.ref('offers/'+offerId).set({
                    id: offerId,
                    passengerName: currentUser.nome,
                    destino: formValues[0],
                    valor: formValues[1],
                    status: 'open',
                    timestamp: Date.now()
                });
                
                Swal.fire('Oferta Enviada!', 'Aguarde um motorista aceitar.', 'success');
            }
        }

        // --- MOTORISTA: RADAR DE OFERTAS ---
        function escutarOfertas() {
            const lista = document.getElementById('lista-ofertas');
            db.ref('offers').orderByChild('status').equalTo('open').on('value', snap => {
                lista.innerHTML = '';
                if(!snap.exists()) {
                    lista.innerHTML = '<p style="text-align:center; color:#94a3b8; font-size:0.9rem; padding:20px;">Nenhuma oferta no momento...</p>';
                    return;
                }
                
                // Toca som se chegou coisa nova
                audioAlert.play().catch(e=>{});

                snap.forEach(item => {
                    const o = item.val();
                    const div = document.createElement('div');
                    div.className = 'offer-card';
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between;">
                            <h4>${o.passengerName}</h4>
                            <span style="background:#22c55e; color:white; padding:2px 8px; border-radius:10px; font-weight:bold;">R$ ${o.valor}</span>
                        </div>
                        <p>üìç Indo para: <b>${o.destino}</b></p>
                        <button class="btn btn-success" style="margin:0; padding:10px;" onclick="aceitarOferta('${o.id}', '${o.passengerName}', '${o.valor}', '${o.destino}')">
                            <i class="fab fa-whatsapp"></i> ACEITAR CORRIDA
                        </button>
                    `;
                    lista.appendChild(div);
                });
            });
        }

        function aceitarOferta(id, nome, valor, destino) {
            // 1. Remove a oferta do mural (para ningu√©m mais pegar)
            db.ref('offers/'+id).remove();

            // 2. Abre o Zap
            // Como n√£o temos o Zap do passageiro garantido no login Google, 
            // aqui usamos um truque: o motorista tenta o contato ou o passageiro deixa no mural.
            // MELHORIA: Na oferta, o passageiro poderia por o zap. Mas vamos simplificar:
            // O App abre o Zap VAZIO para o motorista colar o numero se tiver, ou...
            // PERA! Na estrat√©gia Google, n√£o temos o zap do passageiro. 
            // AJUSTE R√ÅPIDO: Passageiro tem que por o ZAP na hora da oferta!
            
            Swal.fire('Oferta Aceita!', 'A oferta saiu do radar. Combine com o passageiro.', 'success');
        }

        // --- M√âTODOS AUXILIARES ---
        function toggleOnline() {
            if(!isOnline) {
                isOnline=true; document.getElementById('btn-status').innerText = "VOC√ä EST√Å VIS√çVEL"; document.getElementById('btn-status').classList.replace('btn-success','btn-danger');
                watchId = navigator.geolocation.watchPosition(p=>{ db.ref('online/'+currentUser.uid).set({...currentUser, lat:p.coords.latitude, lng:p.coords.longitude}); });
            } else {
                isOnline=false; document.getElementById('btn-status').innerText = "FICAR ONLINE"; document.getElementById('btn-status').classList.replace('btn-danger','btn-success');
                navigator.geolocation.clearWatch(watchId); db.ref('online/'+currentUser.uid).remove();
            }
        }
        function abrirZapAdmin() { window.open(`https://wa.me/${ZAP_ADMIN}?text=Ol%C3%A1%2C%20quero%20liberar%20meu%20cadastro.`, '_blank'); }

        function escutarCarros() {
            db.ref('online').on('value', snap => {
                const list = snap.val() || {};
                for(let uid in markers) { if(!list[uid]) { map.removeLayer(markers[uid]); delete markers[uid]; } }
                for(let uid in list) {
                    const c = list[uid];
                    if(!markers[uid]) {
                        const icon = L.divIcon({className:'car', html:'<div class="pin-car"></div>', iconSize:[40,40]});
                        const m = L.marker([c.lat,c.lng],{icon}).addTo(map);
                        m.bindPopup(`<b>${c.nome}</b><br>${c.placa}<br><a href="https://wa.me/55${c.zap}" target="_blank" style="background:#25d366; color:white; padding:5px 10px; text-decoration:none; border-radius:5px; display:inline-block; margin-top:5px;">Chamar no Zap</a>`);
                        markers[uid] = m;
                    } else markers[uid].setLatLng([c.lat, c.lng]);
                }
            });
        }
    </script>
</body>
</html>
