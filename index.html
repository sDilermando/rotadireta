<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rota Direta Oficial</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --success: #10b981; --bg: #f8fafc; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; transition: 0.3s; overflow-y: auto; }
        .hidden { display: none !important; }
        .card { background: white; padding: 30px; border-radius: 24px; width: 100%; max-width: 360px; box-shadow: 0 20px 60px -10px rgba(0,0,0,0.15); }
        .logo { font-size: 2.2rem; font-weight: 900; color: var(--primary); margin-bottom: 20px; text-align: center; }
        .logo span { color: var(--accent); }
        .inp { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 12px; font-size: 1rem; margin-bottom: 10px; background: #f8fafc; box-sizing:border-box; outline:none; }
        .inp:focus { border-color: var(--accent); background: white; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: 700; cursor: pointer; margin-top: 10px; color: white; display:flex; justify-content:center; align-items:center; gap:10px; transition:0.2s; }
        .btn:active { transform:scale(0.98); }
        .btn-primary { background: var(--primary); }
        .btn-google { background: white; color: #333; border: 2px solid #e2e8f0; }
        .btn-success { background: var(--success); }
        .btn-outline { background: white; border: 2px solid #e2e8f0; color: var(--primary); }
        .file-btn { display: flex; justify-content: space-between; padding: 14px; border: 2px dashed #cbd5e1; border-radius: 12px; cursor: pointer; color: #64748b; margin-top: 5px; background: #f8fafc; font-size: 0.9rem; align-items: center; }
        .file-btn.uploaded { border-color: var(--success); color: var(--success); background: #ecfdf5; font-weight: bold; }
        .file-input { display: none; }
        #app-ui { display: none; flex: 1; position: relative; }
        #map { width: 100%; height: 100%; }
        #driver-dock { position: absolute; bottom: 30px; left: 20px; right: 20px; background: white; padding: 15px; border-radius: 18px; z-index: 1000; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .pin-eu { width: 20px; height: 20px; background: var(--accent); border: 3px solid white; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .pin-car { width: 40px; height: 40px; background-image: url('https://cdn-icons-png.flaticon.com/512/3202/3202926.png'); background-size: contain; background-repeat: no-repeat; filter: drop-shadow(0 3px 2px rgba(0,0,0,0.3)); }
    </style>
</head>
<body>

    <div id="screen-splash" class="screen">
        <div class="logo">ROTA <span>DIRETA</span></div>
        <div class="card">
            <button class="btn btn-google" onclick="loginGoogle()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Passageiro (Google)
            </button>
            <div style="text-align:center; margin:20px 0; font-size:0.8rem; color:#ccc; font-weight:bold;">ÁREA DO PARCEIRO</div>
            <button class="btn btn-primary" onclick="showScreen('screen-login-mot')"><i class="fas fa-car"></i> Sou Motorista</button>
        </div>
        <div style="margin-top:30px; color:#94a3b8; font-size:0.7rem;">Versão 17.4 (Turbo)</div>
    </div>

    <div id="screen-login-mot" class="screen hidden">
        <div class="card">
            <h3 style="text-align:center; margin-top:0;">Login Motorista</h3>
            <input id="login-email" class="inp" type="email" placeholder="Seu E-mail">
            <input id="login-pin" class="inp" type="tel" maxlength="4" placeholder="PIN (4 dígitos)" style="text-align:center; letter-spacing:5px; font-weight:bold;">
            <button class="btn btn-primary" onclick="fazerLoginMotorista()">ACESSAR SISTEMA</button>
            <button class="btn btn-outline" onclick="showScreen('screen-register-mot')">CRIAR NOVA CONTA</button>
            <div onclick="showScreen('screen-splash')" style="text-align:center; margin-top:15px; font-size:0.8rem; cursor:pointer; color:#64748b;">Voltar</div>
        </div>
    </div>

    <div id="screen-register-mot" class="screen hidden">
        <div class="card">
            <h3 style="text-align:center; margin-top:0;">Novo Cadastro</h3>
            <input id="m-nome" class="inp" placeholder="Nome Completo">
            <input id="m-email" class="inp" type="email" placeholder="E-mail Válido">
            <input id="m-pass" class="inp" type="password" placeholder="Crie uma Senha">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <input id="m-placa" class="inp" placeholder="PLACA" style="text-transform:uppercase">
                <input id="m-zap" class="inp" type="tel" placeholder="WhatsApp">
            </div>
            <p style="font-size:0.8rem; font-weight:bold; color:#64748b; margin:10px 0 5px 0;">Envie fotos dos documentos:</p>
            <label class="file-btn" id="lbl-cnh"><span><i class="fas fa-id-card"></i> Foto da CNH</span><input type="file" id="file-cnh" class="file-input" accept="image/*" onchange="markUploaded('lbl-cnh')"></label>
            <label class="file-btn" id="lbl-carro"><span><i class="fas fa-car"></i> Foto do Carro</span><input type="file" id="file-carro" class="file-input" accept="image/*" onchange="markUploaded('lbl-carro')"></label>
            
            <div style="margin-top:15px; font-size:0.8rem; display:flex; gap:5px;"><input type="checkbox" id="m-terms"><span>Declaro que os dados são verdadeiros.</span></div>
            <button class="btn btn-success" onclick="registrarMotorista()">ENVIAR PARA APROVAÇÃO</button>
            <div onclick="showScreen('screen-login-mot')" style="text-align:center; margin-top:10px; cursor:pointer; color:#64748b;">Cancelar</div>
        </div>
    </div>

    <div id="screen-wait" class="screen hidden">
        <div class="card" style="text-align:center;">
            <i class="fas fa-circle-notch fa-spin" style="font-size:3rem; color:var(--accent); margin-bottom:20px;"></i>
            <p>Criando conta...</p>
        </div>
    </div>

    <div id="app-ui">
        <div id="map"></div>
        <div style="position:absolute; top:20px; right:20px; z-index:1000;">
            <button onclick="location.reload()" style="background:white; border:none; padding:10px; border-radius:50%; box-shadow:0 4px 10px rgba(0,0,0,0.2); color:red;"><i class="fas fa-power-off"></i></button>
        </div>
        <div id="driver-dock">
            <button id="btn-status" class="btn btn-success" onclick="toggleOnline()">FICAR ONLINE</button>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBxbRiYNuGde5nwJIaoeRItWdZGR221cpY", authDomain: "rota-direta.firebaseapp.com", projectId: "rota-direta", databaseURL: "https://rota-direta-default-rtdb.firebaseio.com" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();
        let map, currentUser, isOnline=false, watchId, markers={};

        function showScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.add('hidden')); document.getElementById('app-ui').style.display='none'; if(id==='app-ui') document.getElementById('app-ui').style.display='flex'; else document.getElementById(id).classList.remove('hidden'); }
        function markUploaded(id){ document.getElementById(id).classList.add('uploaded'); document.getElementById(id).innerHTML='<i class="fas fa-check"></i> Foto OK'; }
        window.onload = () => { try { IMask(document.getElementById('m-zap'),{mask:'(00) 00000-0000'}); } catch(e){} }

        function loginGoogle(){ auth.signInWithPopup(provider).then(r=>{ const u = r.user; db.ref('passengers/'+u.uid).update({uid:u.uid, nome:u.displayName, foto:u.photoURL, type:'passenger'}); currentUser={uid:u.uid, nome:u.displayName, foto:u.photoURL, type:'passenger'}; entrarApp(); }).catch(e=>Swal.fire('Erro',e.message,'error')); }

        async function registrarMotorista() {
            // VERIFICAÇÕES BÁSICAS
            if(!document.getElementById('m-terms').checked) return Swal.fire('Ops','Aceite os termos.','warning');
            
            showScreen('screen-wait');
            
            try {
                // --- PULO DO GATO: Desativei o Upload por enquanto ---
                // await uploadFile('file-cnh'); 
                
                const email = document.getElementById('m-email').value;
                const pass = document.getElementById('m-pass').value;
                
                // CRIA NO FIREBASE
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                const pin = Math.floor(1000+Math.random()*9000);
                
                // SALVA NO BANCO
                await db.ref('drivers/'+cred.user.uid).set({
                    uid: cred.user.uid,
                    nome: document.getElementById('m-nome').value,
                    email: email,
                    placa: document.getElementById('m-placa').value.toUpperCase(),
                    zap: document.getElementById('m-zap').value.replace(/\D/g,''),
                    pin: pin,
                    status: 'pendente',
                    carro: 'Simulado (Upload Pendente)', // Marcador para sabermos que pulou
                    createdAt: Date.now()
                });

                Swal.fire({
                    title:'Sucesso!', 
                    html:`Seu PIN é: <b style="font-size:2rem">${pin}</b><br>Aguarde aprovação do Admin.`, 
                    icon:'success'
                }).then(()=>location.reload());

            } catch(e) { 
                showScreen('screen-register-mot'); 
                Swal.fire('Erro', e.message, 'error'); 
            }
        }

        async function fazerLoginMotorista() {
            const email = document.getElementById('login-email').value;
            const pin = document.getElementById('login-pin').value;
            const snap = await db.ref('drivers').orderByChild('email').equalTo(email).get();
            if(snap.exists()) {
                const uid = Object.keys(snap.val())[0];
                const user = snap.val()[uid];
                if(user.pin == pin) {
                    if(user.status === 'pendente') return Swal.fire('Aguarde', 'Cadastro em análise pelo Admin.', 'info');
                    if(user.status === 'rejeitado') return Swal.fire('Ops', 'Acesso negado.', 'error');
                    currentUser = user; entrarApp();
                } else Swal.fire('Erro', 'PIN Incorreto.', 'error');
            } else Swal.fire('Erro', 'E-mail não encontrado.', 'error');
        }

        function entrarApp() {
            showScreen('app-ui');
            if(currentUser.type !== 'passenger') document.getElementById('driver-dock').style.display='block';
            if(!map) { map = L.map('map',{zoomControl:false}).setView([-23.55,-46.63],15); L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map); }
            navigator.geolocation.getCurrentPosition(p=>{
                map.setView([p.coords.latitude, p.coords.longitude],17);
                const html = currentUser.foto ? `<img src="${currentUser.foto}" style="width:30px;height:30px;border-radius:50%;border:2px solid blue;">` : `<div class="pin-eu"></div>`;
                L.marker([p.coords.latitude, p.coords.longitude],{icon:L.divIcon({className:'eu',html:html})}).addTo(map);
            });
            if(currentUser.type === 'passenger') escutarCarros();
        }

        function toggleOnline() {
            if(!isOnline) {
                isOnline=true; document.getElementById('btn-status').innerText = "VOCÊ ESTÁ VISÍVEL";
                watchId = navigator.geolocation.watchPosition(p=>{ db.ref('online/'+currentUser.uid).set({...currentUser, lat:p.coords.latitude, lng:p.coords.longitude, status:'livre'}); });
            } else {
                isOnline=false; document.getElementById('btn-status').innerText = "FICAR ONLINE";
                navigator.geolocation.clearWatch(watchId); db.ref('online/'+currentUser.uid).remove();
            }
        }
        function escutarCarros() {
            db.ref('online').on('value', snap => {
                const list = snap.val() || {};
                for(let uid in markers) { if(!list[uid]) { map.removeLayer(markers[uid]); delete markers[uid]; } }
                for(let uid in list) {
                    const c = list[uid];
                    if(!markers[uid]) {
                        const icon = L.divIcon({className:'car', html:'<div class="pin-car"></div>', iconSize:[40,40]});
                        const m = L.marker([c.lat,c.lng],{icon}).addTo(map);
                        m.bindPopup(`<b>${c.nome}</b><br>${c.placa}`);
                        markers[uid] = m;
                    } else markers[uid].setLatLng([c.lat, c.lng]);
                }
            });
        }
    </script>
</body>
</html>
