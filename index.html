<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EcoRota - 100% Sustent√°vel</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/94/94203.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --primary: #065f46; --eco: #10b981; --bg: #ecfdf5; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); overflow: hidden; height: 100vh; width: 100vw; position: fixed; }
        
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; transition: 0.3s; }
        .hidden { display: none !important; }
        
        .logo { font-size: 2.5rem; font-weight: 900; color: var(--primary); margin-bottom: 20px; }
        .logo span { color: var(--eco); }

        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; margin-top: 15px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-google { background: white; border: 2px solid #e5e7eb; color: #374151; }
        .btn-eco { background: var(--eco); color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .btn-outline { background: transparent; border: 2px solid var(--eco); color: var(--eco); }
        
        .inp { width: 100%; padding: 15px; border: 2px solid #e5e7eb; border-radius: 12px; margin-bottom: 10px; font-size: 1rem; outline: none; }

        /* MOSAICO ECO */
        .mosaic { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-bottom: 15px; }
        .mosaic-item { border: 2px solid #e5e7eb; border-radius: 15px; padding: 15px; text-align: center; cursor: pointer; }
        .mosaic-item.selected { border-color: var(--eco); background: #d1fae5; }
        .mosaic-item i { font-size: 2rem; color: #9ca3af; display: block; margin-bottom: 5px; }

        #map { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; }
        .float-btn { position: absolute; z-index: 50; width: 45px; height: 45px; border-radius: 50%; background: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        #btn-exit { top: 20px; left: 20px; color: #333; }
        #btn-sos { top: 20px; right: 20px; background: #ef4444; color: white; animation: pulse 2s infinite; font-weight: bold; font-size: 0.7rem; }
        
        #action-btn { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 50; border: 2px solid var(--eco); cursor: pointer; display: flex; align-items: center; gap: 10px; white-space: nowrap; }

        .footer-info { position: absolute; bottom: 10px; width: 100%; text-align: center; font-size: 0.7rem; color: #6b7280; background: rgba(255,255,255,0.9); padding: 5px; z-index: 200; pointer-events: none; }
        
        /* ESTRELA ANIMADA */
        .star-anim { font-size: 4rem; color: #fbbf24; animation: spinPop 0.8s ease-out; display: block; margin: 0 auto 10px auto; }
        @keyframes spinPop { 0% { transform: scale(0) rotate(-180deg); } 80% { transform: scale(1.2) rotate(20deg); } 100% { transform: scale(1) rotate(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="screen-login" class="screen">
        <div class="logo">Eco<span>Rota</span></div>
        <div style="width: 100%; max-width: 320px;">
            <button class="btn btn-google" onclick="loginFlow()">
                <i class="fab fa-google"></i> Entrar / Cadastrar
            </button>
        </div>
        <p style="margin-top:30px; font-size:0.8rem; color:#9ca3af;">Vers√£o Sustent√°vel 2.0</p>
    </div>

    <div id="screen-terms" class="screen hidden">
        <h3 style="color:var(--primary)">Compromisso Verde</h3>
        <div style="height: 150px; overflow-y: auto; background: #f9fafb; padding: 15px; border: 1px solid #e5e7eb; font-size: 0.85rem; text-align: justify; margin-bottom: 20px;">
            <p>1. O EcoRota √© exclusivo para mobilidade limpa (Bike, El√©trico, A P√©).</p>
            <p>2. Ve√≠culos a combust√£o s√£o proibidos.</p>
            <p>3. Valores s√£o negociados livremente.</p>
            <p>4. Seguran√ßa √© responsabilidade do prestador.</p>
        </div>
        <label><input type="checkbox" id="check-terms" onchange="toggleBtn()"> Aceito colaborar com o planeta.</label>
        <button id="btn-accept" class="btn btn-eco" onclick="aceitarTermos()" disabled style="opacity:0.5">CONTINUAR</button>
    </div>

    <div id="screen-role" class="screen hidden">
        <h3 style="color:var(--primary)">Quem √© voc√™?</h3>
        <div style="width: 100%; max-width: 320px;">
            <button class="btn btn-eco" onclick="escolherPerfil('user')">üôã SOU USU√ÅRIO</button>
            <button class="btn btn-outline" onclick="escolherPerfil('provider')">üö≤ SOU PRESTADOR</button>
        </div>
    </div>

    <div id="screen-provider-reg" class="screen hidden">
        <h3 style="margin-top:0;">Cadastro Eco</h3>
        <div style="width: 100%; max-width: 320px; max-height: 90vh; overflow-y: auto;">
            <div class="mosaic">
                <div class="mosaic-item" onclick="selVeh(this, 'Bike Comum')"><i class="fas fa-bicycle"></i><span>Bike</span></div>
                <div class="mosaic-item" onclick="selVeh(this, 'Bike El√©trica')"><i class="fas fa-bolt"></i><span>E-Bike</span></div>
                <div class="mosaic-item" onclick="selVeh(this, 'Patinete El√©trico')"><i class="fas fa-scooter"></i><span>Patinete</span></div>
                <div class="mosaic-item" onclick="selVeh(this, 'Office Boy')"><i class="fas fa-walking"></i><span>A P√©</span></div>
            </div>
            <input type="hidden" id="prov-veh">
            <input id="prov-name" class="inp" placeholder="Nome Completo">
            <input id="prov-zap" class="inp" type="tel" placeholder="WhatsApp">
            
            <p style="font-size:0.8rem; color:#6b7280; text-align:center;">
                Envie seus dados para aprova√ß√£o.
            </p>
            
            <button class="btn btn-outline" onclick="enviarZap()">1. ENVIAR PARA APROVA√á√ÉO</button>
            <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
            <input id="prov-pass" class="inp" type="text" placeholder="Cole a SENHA aqui" style="text-align:center; letter-spacing: 2px; font-weight: bold;">
            <button class="btn btn-eco" onclick="validarSenha()">2. ENTRAR ONLINE</button>
            <button class="btn btn-outline" onclick="location.reload()" style="border:none; color:#999">Cancelar</button>
        </div>
    </div>

    <div id="screen-map" class="screen hidden" style="background: transparent; padding: 0; display: block;">
        <div id="map"></div>
        <button id="btn-exit" class="float-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
        <button id="btn-sos" class="float-btn" onclick="sos()">SOS</button>

        <button id="action-btn" onclick="acaoPrincipal()">
            CARREGANDO...
        </button>

        <div class="footer-info"><i class="fas fa-leaf"></i> Voc√™ est√° usando um app 100% sustent√°vel.</div>
    </div>

    <script>
        const SENHA_MESTRA = "ECO2025"; 
        const ZAP_ADMIN = "5532984099000";

        let map, myMarker, userRole;

        const icons = {
            bike: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/94/94203.png', iconSize:[32,32]}),
            ebike: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/3082/3082383.png', iconSize:[32,32]}),
            scooter: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/2554/2554936.png', iconSize:[32,32]}),
            ape: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/72/72908.png', iconSize:[32,32]}),
            eu: L.divIcon({className:'pin', html:`<div style="width:16px;height:16px;background:#047857;border:3px solid white;border-radius:50%;box-shadow:0 0 0 10px rgba(16,185,129,0.3);"></div>`})
        };

        window.onload = () => {
            IMask(document.getElementById('prov-zap'), {mask:'(00) 00000-0000'});
            const salvo = localStorage.getItem('ecoRotaUser');
            if(salvo) {
                const dados = JSON.parse(salvo);
                iniciarAppDireto(dados.role, dados.nome);
            }
        };

        function loginFlow() { trocarTela('screen-login', 'screen-terms'); }
        function toggleBtn() {
            const chk = document.getElementById('check-terms');
            document.getElementById('btn-accept').disabled = !chk.checked;
            document.getElementById('btn-accept').style.opacity = chk.checked ? 1 : 0.5;
        }
        function aceitarTermos() { trocarTela('screen-terms', 'screen-role'); }

        function escolherPerfil(tipo) {
            if(tipo === 'user') {
                Swal.fire({
                    title: 'Seu Nome',
                    input: 'text',
                    confirmButtonText: 'Entrar',
                    confirmButtonColor: '#047857'
                }).then((res) => {
                    if(res.value) salvarELogar('user', res.value);
                });
            } else {
                trocarTela('screen-role', 'screen-provider-reg');
            }
        }

        function selVeh(el, tipo) {
            document.querySelectorAll('.mosaic-item').forEach(i => i.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('prov-veh').value = tipo;
        }

        function enviarZap() {
            const nome = document.getElementById('prov-name').value;
            const zap = document.getElementById('prov-zap').value;
            const veh = document.getElementById('prov-veh').value;
            if(!nome || !zap || !veh) return Swal.fire('Erro', 'Preencha tudo.', 'warning');
            const msg = `Ol√°! Quero ser prestador EcoRota.%0A%0ANome: ${nome}%0AZap: ${zap}%0AVe√≠culo: ${veh}`;
            window.open(`https://wa.me/${ZAP_ADMIN}?text=${msg}`, '_blank');
        }

        function validarSenha() {
            const senha = document.getElementById('prov-pass').value.toUpperCase().trim();
            const nome = document.getElementById('prov-name').value;
            if(senha === SENHA_MESTRA) {
                Swal.fire('Liberado!', 'Bem-vindo.', 'success').then(() => salvarELogar('provider', nome));
            } else {
                Swal.fire('Senha Inv√°lida', 'Aguarde aprova√ß√£o.', 'error');
            }
        }

        function salvarELogar(role, nome) {
            localStorage.setItem('ecoRotaUser', JSON.stringify({ role, nome }));
            iniciarAppDireto(role, nome);
        }

        function iniciarAppDireto(role, nome) {
            userRole = role;
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-map').classList.remove('hidden');

            const btn = document.getElementById('action-btn');
            if(role === 'user') {
                btn.innerHTML = '<i class="fas fa-search-location"></i> BUSCAR PRESTADOR';
                btn.style.background = '#047857';
            } else {
                btn.innerHTML = '<i class="fas fa-leaf"></i> VOC√ä EST√Å ONLINE';
                btn.style.background = '#10b981';
            }
            iniciarMapa();
        }

        function iniciarMapa() {
            if(!map) {
                map = L.map('map', {zoomControl: false}).setView([-21.135, -44.261], 15);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            }
            setTimeout(() => map.invalidateSize(), 500);

            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(p => {
                    const lat = p.coords.latitude;
                    const lng = p.coords.longitude;
                    
                    if(myMarker) map.removeLayer(myMarker);
                    myMarker = L.marker([lat, lng], {icon: icons.eu}).addTo(map);
                    map.setView([lat, lng], 17);

                    if(userRole === 'user') simularPrestadoresNoMapa(lat, lng);

                }, () => {}, {enableHighAccuracy: true});
            }
        }

        function simularPrestadoresNoMapa(lat, lng) {
            L.marker([lat + 0.002, lng + 0.002], {icon: icons.bike}).addTo(map).bindPopup("Bike Pr√≥xima");
            L.marker([lat - 0.002, lng - 0.002], {icon: icons.scooter}).addTo(map).bindPopup("Patinete Pr√≥ximo");
            L.marker([lat + 0.001, lng - 0.003], {icon: icons.ape}).addTo(map).bindPopup("Office Boy");
        }

        // --- FLUXO PRINCIPAL COM PREMIA√á√ÉO ECOL√ìGICA ---
        async function acaoPrincipal() {
            if(userRole === 'provider') {
                Swal.fire('Online', 'Aguarde chamados no WhatsApp.', 'info');
                return;
            }

            // 1. ESCOLHA (SEM MOTO)
            const { value: cat } = await Swal.fire({
                title: 'Escolha Sustent√°vel',
                input: 'select',
                inputOptions: {
                    'bike': 'üö≤ Bicicleta Comum (Barato)',
                    'ebike': '‚ö° E-Bike (R√°pido)',
                    'scooter': 'üõ¥ Patinete El√©trico',
                    'ape': 'üëü A P√© (Office Boy)'
                },
                inputPlaceholder: 'Selecione...',
                showCancelButton: true,
                confirmButtonText: 'PR√ìXIMO >>',
                confirmButtonColor: '#047857'
            });

            if(!cat) return;

            // 2. DESCRI√á√ÉO
            const { value: desc } = await Swal.fire({
                title: 'O que precisa?',
                input: 'text',
                inputPlaceholder: 'Ex: Buscar envelope...',
                confirmButtonText: 'BUSCAR',
                confirmButtonColor: '#047857'
            });

            if(desc) {
                Swal.fire({title: 'Localizando...', html: 'Buscando parceiro <b>'+cat.toUpperCase()+'</b>...', didOpen: () => Swal.showLoading()});
                
                setTimeout(() => {
                    const nomes = ["Carlos", "Maria", "Jo√£o", "Ana"];
                    const nome = nomes[Math.floor(Math.random() * nomes.length)];
                    
                    // 3. ENCONTRADO
                    Swal.fire({
                        title: 'Encontrado!',
                        html: `
                            <div style="text-align:center;">
                                <div style="font-size:3rem; margin-bottom:10px;">${obterIconeHtml(cat)}</div>
                                <h3>${nome}</h3>
                                <p style="color:#059669; font-weight:bold;">${cat.toUpperCase()}</p>
                                <p>üìç A 300 metros</p>
                                <hr>
                                <small>Combine o valor no WhatsApp</small>
                            </div>
                        `,
                        confirmButtonText: 'ACEITAR E CHAMAR',
                        confirmButtonColor: '#047857',
                        showCancelButton: true,
                        cancelButtonText: 'Cancelar'
                    }).then((res) => {
                        if(res.isConfirmed) {
                            // 4. PREMIA√á√ÉO ECOL√ìGICA (O GRAN FINALE)
                            Swal.fire({
                                title: 'PARAB√âNS! üåç',
                                html: `
                                    <i class="fas fa-star star-anim"></i>
                                    <h3>Voc√™ colaborou com o planeta!</h3>
                                    <p>Evitou CO2 usando transporte limpo.</p>
                                    <p style="color:#fbbf24; font-weight:bold; font-size:1.2rem;">+1 Estrela Eco</p>
                                `,
                                confirmButtonText: '<i class="fab fa-whatsapp"></i> ABRIR WHATSAPP',
                                confirmButtonColor: '#25D366'
                            }).then((final) => {
                                if(final.isConfirmed) window.open('https://wa.me/5532999999999', '_blank');
                            });
                        }
                    });
                }, 2000);
            }
        }

        function obterIconeHtml(cat) {
            if(cat === 'bike') return 'üö≤';
            if(cat === 'ebike') return '‚ö°';
            if(cat === 'scooter') return 'üõ¥';
            return 'üëü';
        }

        function trocarTela(atual, proxima) {
            document.getElementById(atual).classList.add('hidden');
            document.getElementById(proxima).classList.remove('hidden');
        }
        function logout() { localStorage.removeItem('ecoRotaUser'); location.reload(); }
        function sos() { window.open('tel:190'); }
    </script>
</body>
</html>
