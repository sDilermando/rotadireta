<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rota Direta - Seguro</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --bg:#f4f4f9; --surface:#fff; --dark:#1a1a2e; --gold:#ffcc00; --green:#00c853; --red:#ff3b30; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; width: 100%; height: 100vh; background: var(--bg); font-family: 'Montserrat', sans-serif; overflow: hidden; display: flex; flex-direction: column; }

        /* LOADING */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--surface); z-index: 10000; display: flex; justify-content: center; align-items: center; color: #888; font-weight: bold; }

        /* TELA INICIAL (SPLASH) - SEMPRE APARECE NO REFRESH */
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--surface); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .logo { font-size: 2.5rem; font-weight: 900; color: var(--dark); margin-bottom: 40px; }
        .logo span { color: var(--gold); }
        
        .btn-big { width: 100%; max-width: 320px; padding: 18px; margin-bottom: 15px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-big:active { transform: scale(0.98); }
        .b-drv { background: var(--dark); color: white; }
        .b-pas { background: white; color: var(--dark); border: 2px solid var(--dark); }

        /* APP */
        #app-ui { display: none; flex: 1; position: relative; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* BARRA LATERAL (BOTÕES PEQUENOS) */
        .side-bar { position: absolute; top: 80px; right: 15px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .btn-icon { width: 45px; height: 45px; border-radius: 50%; border: none; background: white; box-shadow: 0 3px 10px rgba(0,0,0,0.2); font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--dark); }
        .btn-panic { background: var(--red); color: white; animation: pulse 2s infinite; }

        /* PAINEL MOTORISTA */
        .driver-dock { position: absolute; bottom: 30px; left: 20px; right: 20px; background: white; padding: 20px; border-radius: 20px; z-index: 1000; text-align: center; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .btn-status { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: 800; font-size: 1rem; text-transform: uppercase; cursor: pointer; }
        .s-off { background: #eee; color: #777; }
        .s-on { background: var(--green); color: white; }
        
        /* PIN */
        .pin-wrap { position: relative; width: 60px; height: 60px; }
        .pin-label { position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: var(--green); color: white; font-size: 0.6rem; font-weight: 900; padding: 3px 6px; border-radius: 4px; white-space: nowrap; }
        .pin-car { width: 40px; height: 40px; background-image: url('https://cdn-icons-png.flaticon.com/512/3202/3202926.png'); background-size: contain; background-repeat: no-repeat; margin: 0 auto; filter: drop-shadow(0 4px 2px rgba(0,0,0,0.3)); }
        
        .status-ocupado .pin-label { background: var(--gold); color: black; }
        .status-alerta .pin-label { background: var(--red); animation: blink 0.5s infinite; }
        .status-alerta .pin-car { filter: sepia(1) hue-rotate(-50deg) saturate(5); }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 59, 48, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 59, 48, 0); } }
        @keyframes blink { 50% { opacity: 0; } }
        
        .legal { position: absolute; bottom: 10px; width: 100%; text-align: center; font-size: 0.6rem; color: #999; }
    </style>
</head>
<body>

    <div id="loading">Conectando...</div>

    <div id="splash">
        <div class="logo">ROTA <span>DIRETA</span></div>
        
        <button class="btn-big b-drv" onclick="acaoMotorista()">
            <i class="fas fa-car"></i> SOU MOTORISTA
        </button>
        
        <button class="btn-big b-pas" onclick="acaoPassageiro()">
            <i class="fas fa-user"></i> SOU PASSAGEIRO
        </button>

        <div class="legal">
            Termos de Uso e Política de Privacidade.<br>
            © Gemini Tech - Uso Seguro
        </div>
    </div>

    <div id="app-ui">
        <div class="side-bar">
            <button class="btn-icon" onclick="compartilhar()"><i class="fas fa-share-alt"></i></button>
            <button class="btn-icon" onclick="meuLocal()"><i class="fas fa-crosshairs"></i></button>
            <button class="btn-icon btn-panic" onclick="panico()"><i class="fas fa-exclamation-triangle"></i></button>
            <button class="btn-icon" onclick="location.reload()" style="color:red"><i class="fas fa-sign-out-alt"></i></button>
        </div>

        <div id="map"></div>

        <div class="driver-dock" id="driverDock">
            <button id="btnOnline" class="btn-status s-off" onclick="toggleOnline()">FICAR ONLINE</button>
            <p id="txtStatus" style="font-size:0.8rem; color:#777; margin-top:10px;">Status: OFFLINE</p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // CONFIGURAÇÃO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBxbRiYNuGde5nwJIaoeRItWdZGR221cpY",
            authDomain: "rota-direta.firebaseapp.com",
            projectId: "rota-direta",
            storageBucket: "rota-direta.firebasestorage.app",
            messagingSenderId: "468273971962",
            appId: "1:468273971962:web:f536de2e2aa74f84dfff43",
            databaseURL: "https://rota-direta-default-rtdb.firebaseio.com"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e) {}
        const db = firebase.database();
        const auth = firebase.auth();

        let map, currentUser, userType, isOnline = false, watchId, markers = {};

        window.onload = () => {
            // Autentica silenciosamente mas NÃO sai da tela Splash
            auth.signInAnonymously().then(() => {
                document.getElementById('loading').style.display = 'none';
                console.log("Firebase Conectado. Aguardando escolha do usuário.");
            }).catch(e => alert("Erro Net: " + e.message));
        };

        // --- LÓGICA DO MOTORISTA ---
        function acaoMotorista() {
            // 1. Verifica se já tem cadastro salvo
            const salvo = localStorage.getItem('rd_driver_v6');
            
            if(salvo) {
                // JÁ TEM CADASTRO -> PEDE SENHA
                const dados = JSON.parse(salvo);
                Swal.fire({
                    title: `Olá, ${dados.nome.split(' ')[0]}`,
                    text: 'Digite sua Senha PIN para entrar:',
                    input: 'password',
                    inputAttributes: { maxlength: 4, inputmode: 'numeric', style: 'text-align:center; font-size:2rem; letter-spacing:5px;' },
                    showDenyButton: true,
                    denyButtonText: 'Esqueci a Senha',
                    confirmButtonText: 'ENTRAR', confirmButtonColor: '#1a1a2e'
                }).then((res) => {
                    if(res.isConfirmed) {
                        if(res.value == dados.pin) {
                            entrarApp('driver', dados);
                        } else {
                            Swal.fire('Senha Incorreta', '', 'error');
                        }
                    } else if (res.isDenied) {
                        recuperarSenha(dados);
                    }
                });
            } else {
                // NÃO TEM CADASTRO -> REGISTRAR
                cadastrarMotorista();
            }
        }

        async function cadastrarMotorista() {
            // Termos de Uso
            const { isConfirmed } = await Swal.fire({
                title: 'Termos de Uso',
                html: '<div style="font-size:0.8rem; text-align:left; max-height:150px; overflow:auto;">O aplicativo é uma ferramenta de conexão. O usuário é responsável por seus atos, dados e segurança. O criador se isenta de responsabilidade legal sobre incidentes. Ao aceitar, você confirma a veracidade dos dados.</div>',
                input: 'checkbox',
                inputValue: 0,
                inputPlaceholder: 'Li e concordo com os termos',
                confirmButtonText: 'CONTINUAR'
            });

            if(!isConfirmed) return;

            // Formulário
            const { value: form } = await Swal.fire({
                title: 'Cadastro Motorista',
                html: `
                    <input id="cadNome" class="swal2-input" placeholder="Nome Completo">
                    <input id="cadCarro" class="swal2-input" placeholder="Carro (Modelo e Cor)">
                    <input id="cadPlaca" class="swal2-input" placeholder="Placa" style="text-transform:uppercase">
                    <input id="cadZap" class="swal2-input" type="tel" placeholder="WhatsApp">
                    <input id="cadEmail" class="swal2-input" type="email" placeholder="E-mail (Recuperação)">
                `,
                confirmButtonText: 'GERAR SENHA',
                preConfirm: () => {
                    return {
                        uid: auth.currentUser.uid,
                        pin: Math.floor(1000 + Math.random() * 9000), // Gera PIN aqui
                        nome: document.getElementById('cadNome').value,
                        carro: document.getElementById('cadCarro').value,
                        placa: document.getElementById('cadPlaca').value.toUpperCase(),
                        zap: document.getElementById('cadZap').value.replace(/\D/g, ''),
                        email: document.getElementById('cadEmail').value
                    }
                }
            });

            if(form) {
                if(!form.nome || !form.placa || !form.email) return Swal.fire('Erro', 'Preencha tudo!', 'error');

                // Salva
                localStorage.setItem('rd_driver_v6', JSON.stringify(form));
                db.ref('drivers/' + form.uid).set(form);

                await Swal.fire({
                    title: 'Cadastro Realizado!',
                    html: `Sua SENHA PIN é: <b style="font-size:3rem; color:#ffcc00">${form.pin}</b><br>Guarde-a bem!`,
                    icon: 'success'
                });

                entrarApp('driver', form);
            }
        }

        async function recuperarSenha(dados) {
            const { value: form } = await Swal.fire({
                title: 'Recuperar Senha',
                html: `<input id="recEmail" class="swal2-input" placeholder="Confirme seu E-mail"><input id="recZap" class="swal2-input" placeholder="Confirme seu WhatsApp">`,
                confirmButtonText: 'VERIFICAR'
            });

            if(form) { // O sweetalert retorna objeto no preconfirm ou value direto
                 const email = document.getElementById('recEmail').value;
                 const zap = document.getElementById('recZap').value.replace(/\D/g,'');

                 if(email === dados.email && zap === dados.zap) {
                     Swal.fire('Sua Senha', `Seu PIN é: <b>${dados.pin}</b>`, 'info');
                 } else {
                     Swal.fire('Dados não conferem', 'Tente novamente.', 'error');
                 }
            }
        }

        // --- LÓGICA DO PASSAGEIRO ---
        function acaoPassageiro() {
            const salvo = localStorage.getItem('rd_pass_v6');
            if(salvo) {
                entrarApp('passenger', JSON.parse(salvo));
            } else {
                cadastrarPassageiro();
            }
        }

        async function cadastrarPassageiro() {
            // Termos
            const { isConfirmed } = await Swal.fire({
                title: 'Termos de Uso',
                html: '<div style="font-size:0.8rem;">O usuário é responsável pelo uso do app. Aceite para continuar.</div>',
                input: 'checkbox',
                inputPlaceholder: 'Concordo',
                confirmButtonText: 'ACEITAR'
            });

            if(!isConfirmed) return;

            const { value: nome } = await Swal.fire({
                title: 'Seu Nome', input: 'text', confirmButtonText: 'ENTRAR'
            });

            if(nome) {
                const form = { uid: auth.currentUser.uid, nome: nome };
                localStorage.setItem('rd_pass_v6', JSON.stringify(form));
                entrarApp('passenger', form);
            }
        }

        // --- SISTEMA COMUM ---
        function entrarApp(type, data) {
            userType = type;
            currentUser = data;
            
            document.getElementById('splash').style.display = 'none';
            document.getElementById('app-ui').style.display = 'flex';
            
            if(type === 'driver') document.getElementById('driverDock').style.display = 'block';

            initMap();
        }

        function initMap() {
            if(!map) {
                map = L.map('map', { zoomControl: false }).setView([-23.55, -46.63], 15);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            }
            meuLocal();
            escutarOnline();
        }

        function toggleOnline() {
            const btn = document.getElementById('btnOnline');
            const txt = document.getElementById('txtStatus');
            
            if(!isOnline) {
                if(!navigator.geolocation) return Swal.fire('Erro', 'Ligue o GPS', 'warning');
                isOnline = true;
                btn.className = 'btn-status s-on';
                btn.innerText = 'VOCÊ ESTÁ VISÍVEL';
                txt.innerText = 'Status: LIVRE (Aguardando corrida)';
                
                watchId = navigator.geolocation.watchPosition(pos => {
                    db.ref('online/'+currentUser.uid).set({
                        ...currentUser, status: 'livre', lat: pos.coords.latitude, lng: pos.coords.longitude
                    });
                }, null, {enableHighAccuracy:true});
            } else {
                isOnline = false;
                btn.className = 'btn-status s-off';
                btn.innerText = 'FICAR ONLINE';
                txt.innerText = 'Status: OFFLINE';
                if(watchId) navigator.geolocation.clearWatch(watchId);
                db.ref('online/'+currentUser.uid).remove();
            }
        }

        function escutarOnline() {
            db.ref('online').on('value', snap => {
                const list = snap.val() || {};
                for(let uid in markers) { if(!list[uid]) { map.removeLayer(markers[uid]); delete markers[uid]; } }

                for(let uid in list) {
                    if(uid === currentUser.uid) continue;
                    const d = list[uid];
                    
                    let css = ''; let lbl = 'LIVRE';
                    if(d.status === 'ocupado') { css = 'status-ocupado'; lbl = 'OCUPADO'; }
                    if(d.status === 'alerta') { css = 'status-alerta'; lbl = 'ALERTA'; }

                    const html = `<div class="pin-wrap ${css}"><div class="pin-label">${lbl}</div><div class="pin-car"></div></div>`;
                    const icon = L.divIcon({ className: 'custom', html: html, iconSize: [60,60] });

                    if(markers[uid]) markers[uid].setLatLng([d.lat, d.lng]).setIcon(icon);
                    else {
                        const m = L.marker([d.lat, d.lng], {icon}).addTo(map);
                        m.on('click', () => {
                            if(d.status === 'ocupado') return Swal.fire('Ocupado', 'Em corrida.', 'info');
                            if(d.status === 'alerta') return Swal.fire('PERIGO', 'Veículo em alerta!', 'error');
                            
                            Swal.fire({
                                title: d.nome,
                                text: `${d.carro} - ${d.placa}`,
                                confirmButtonText: 'CHAMAR NO ZAP',
                                confirmButtonColor: '#00c853'
                            }).then((r) => {
                                if(r.isConfirmed) {
                                    db.ref('online/'+d.uid).update({status: 'ocupado'});
                                    window.open(`https://wa.me/55${d.zap}`, '_blank');
                                }
                            });
                        });
                        markers[uid] = m;
                    }
                }
            });
        }

        function panico() {
            if(confirm("ACIONAR BOTÃO DE PÂNICO?")) {
                if(!isOnline && userType==='driver') toggleOnline();
                db.ref('online/'+currentUser.uid).update({status: 'alerta'});
                Swal.fire('ALERTA ENVIADO', 'Seu ícone está vermelho para todos.', 'warning');
            }
        }

        function meuLocal() {
            navigator.geolocation.getCurrentPosition(p => {
                map.setView([p.coords.latitude, p.coords.longitude], 16);
                L.circleMarker([p.coords.latitude, p.coords.longitude], {radius:8}).addTo(map);
            });
        }

        function compartilhar() {
            const url = window.location.href;
            if(navigator.share) navigator.share({title:'Rota Direta', url: url});
            else Swal.fire('Link', url, 'info');
        }

        // Timer de Segurança (10 min inativo cai)
        let timer;
        document.onclick = () => { clearTimeout(timer); timer = setTimeout(() => { if(isOnline) toggleOnline(); }, 600000); };

    </script>
</body>
</html>
