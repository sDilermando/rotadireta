<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rota Eco - Leve</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/94/94203.png">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* ESTILO SUPER LEVE */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: sans-serif; background: #f0fdf4; overflow: hidden; height: 100vh; width: 100vw; }
        
        /* TELAS */
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .hidden { display: none !important; }
        
        /* ELEMENTOS */
        .logo { font-size: 2rem; font-weight: 900; color: #064e3b; margin-bottom: 20px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; margin-top: 10px; color: white; background: #10b981; cursor: pointer; font-size: 1rem; }
        .btn:active { opacity: 0.8; }
        .btn-outline { background: white; border: 2px solid #10b981; color: #10b981; }
        .inp { width: 100%; padding: 15px; border: 1px solid #ccc; border-radius: 10px; margin-bottom: 10px; font-size: 1rem; }

        /* MAPA */
        #map { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; }
        
        /* INTERFACE FLUTUANTE */
        .ui-layer { position: absolute; z-index: 5; width: 100%; height: 100%; pointer-events: none; }
        .pointer-events-auto { pointer-events: auto; }
        
        .float-btn { position: absolute; width: 45px; height: 45px; background: white; border-radius: 50%; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; pointer-events: auto; display:flex; align-items:center; justify-content:center; font-size:1.2rem; }
        #btn-menu { top: 20px; left: 20px; }
        #btn-sos { top: 20px; right: 20px; background: #ef4444; color: white; }
        #btn-gps { bottom: 100px; right: 20px; color: #10b981; }

        #bottom-panel { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; pointer-events: auto; }
        
        .req-btn { background: #064e3b; color: white; padding: 15px; border-radius: 50px; width: 100%; border: none; font-weight: bold; font-size: 1.1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; gap: 10px; cursor: pointer; }

        /* LISTA PRESTADOR */
        .provider-card { background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: none; pointer-events: auto; }
        .active-card { display: block; animation: popUp 0.3s; }

        @keyframes popUp { from { transform: translateY(20px); opacity:0; } to { transform: translateY(0); opacity:1; } }
    </style>
</head>
<body>

    <div id="screen-login" class="screen">
        <div class="logo">ROTA <span>ECO</span></div>
        <div style="width: 100%; max-width: 300px;">
            <button class="btn" onclick="entrar('user')">üôã SOU CLIENTE</button>
            <button class="btn btn-outline" onclick="entrar('provider')">üö≤ SOU PRESTADOR</button>
        </div>
        <p style="margin-top:20px; font-size:0.8rem; color:#666;">Vers√£o Leve 31.0</p>
    </div>

    <div id="screen-register" class="screen hidden">
        <h3>Cadastro R√°pido</h3>
        <div style="width: 100%; max-width: 300px;">
            <select id="reg-veh" class="inp">
                <option value="bike">Bicicleta</option>
                <option value="ebike">Bike El√©trica</option>
                <option value="scooter">Scooter</option>
                <option value="ape">A P√© / Office Boy</option>
            </select>
            <input id="reg-nome" class="inp" placeholder="Seu Nome">
            <div style="font-size:0.8rem; margin:10px 0;">
                <input type="checkbox" id="terms" checked> Aceito os termos de uso.
            </div>
            <button class="btn" onclick="finalizarCadastro()">ENTRAR ONLINE</button>
            <button class="btn btn-outline" onclick="location.reload()">VOLTAR</button>
        </div>
    </div>

    <div id="screen-app" class="screen hidden" style="background:transparent; padding:0; display:block;">
        <div id="map"></div>
        
        <div class="ui-layer">
            <button id="btn-menu" class="float-btn" onclick="msg('Menu do App')"><i class="fas fa-bars"></i></button>
            <button id="btn-sos" class="float-btn" onclick="msg('Ligando 190...')">SOS</button>
            <button id="btn-gps" class="float-btn" onclick="centralizar()"><i class="fas fa-crosshairs"></i></button>

            <div id="bottom-panel">
                <button id="btn-pedir" class="req-btn hidden" onclick="fazerPedido()">
                    <i class="fas fa-leaf"></i> SOLICITAR AGORA
                </button>

                <div id="provider-panel" class="hidden">
                    <div style="background:white; padding:15px; border-radius:20px; text-align:center;">
                        <span style="color:#10b981; font-weight:bold;">üü¢ VOC√ä EST√Å ONLINE</span>
                        <div id="lista-pedidos" style="margin-top:10px;">
                            <p style="color:#999; font-size:0.9rem;">Aguardando chamados...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- MOTOR DO APP (SIMPLES E ROBUSTO) ---
        
        let map;
        let myMarker;
        let role = '';
        let icons = {};

        // INICIALIZA√á√ÉO SEGURA
        window.onload = function() {
            // Define √≠cones uma vez s√≥
            const size = [38, 38];
            const anchor = [19, 19];
            icons = {
                bike: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/94/94203.png', iconSize:size, iconAnchor:anchor}),
                ebike: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/3082/3082383.png', iconSize:size, iconAnchor:anchor}),
                scooter: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/2554/2554936.png', iconSize:size, iconAnchor:anchor}),
                ape: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/72/72908.png', iconSize:size, iconAnchor:anchor}),
                user: L.divIcon({className:'eu', html:'<div style="width:16px;height:16px;background:#059669;border:3px solid white;border-radius:50%;box-shadow:0 0 0 10px rgba(16,185,129,0.3);"></div>'})
            };
        };

        // 1. NAVEGA√á√ÉO
        function entrar(tipo) {
            role = tipo;
            document.getElementById('screen-login').classList.add('hidden');
            
            if (tipo === 'user') {
                iniciarMapa();
                document.getElementById('btn-pedir').classList.remove('hidden');
            } else {
                document.getElementById('screen-register').classList.remove('hidden');
            }
        }

        function finalizarCadastro() {
            const nome = document.getElementById('reg-nome').value;
            if(nome.length < 3) return alert("Digite seu nome!");
            
            document.getElementById('screen-register').classList.add('hidden');
            iniciarMapa();
            document.getElementById('provider-panel').classList.remove('hidden');
            
            // Simula pedidos chegando para o prestador
            simularPedidos();
        }

        // 2. SISTEMA DE MAPA (COM PROTE√á√ÉO)
        function iniciarMapa() {
            document.getElementById('screen-app').classList.remove('hidden');

            setTimeout(() => {
                // Tenta carregar o mapa
                if(!map) {
                    map = L.map('map', {zoomControl: false}).setView([-21.135, -44.261], 15); // SJDR Padr√£o
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; OpenStreetMap'
                    }).addTo(map);
                }
                map.invalidateSize(); // Destrava tela cinza

                // Tenta pegar GPS
                if(navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            const lat = pos.coords.latitude;
                            const lng = pos.coords.longitude;
                            
                            // Cria √≠cone
                            const icone = role === 'user' ? icons.user : icons.bike;
                            myMarker = L.marker([lat, lng], {icon: icone}).addTo(map);
                            map.setView([lat, lng], 16);
                            
                            // Se for usu√°rio, cria uns prestadores fake em volta
                            if(role === 'user') criarFakes(lat, lng);
                        },
                        (err) => {
                            alert("GPS desligado ou bloqueado. Usando localiza√ß√£o padr√£o.");
                        },
                        { enableHighAccuracy: true }
                    );
                }
            }, 500);
        }

        // 3. FLUXO DE PEDIDO (USU√ÅRIO)
        async function fazerPedido() {
            const { value: form } = await Swal.fire({
                title: 'Novo Pedido',
                html: `
                    <select id="p-cat" class="inp"><option>üö≤ Bike</option><option>üëü A P√©</option></select>
                    <input id="p-desc" class="inp" placeholder="O que precisa?">
                `,
                confirmButtonText: 'CHAMAR',
                confirmButtonColor: '#064e3b',
                focusConfirm: false,
                preConfirm: () => [document.getElementById('p-cat').value, document.getElementById('p-desc').value]
            });

            if(form) {
                Swal.fire({
                    title: 'Procurando...',
                    text: 'Aguarde um prestador aceitar.',
                    showConfirmButton: false,
                    didOpen: () => { Swal.showLoading() }
                });

                // Simula resposta em 3s
                setTimeout(() => {
                    Swal.fire('ACEITO! üåü', 'Carlos (Bike) aceitou.<br>Indo para o WhatsApp...', 'success');
                }, 3000);
            }
        }

        // 4. SIMULA√á√ÉO PARA PRESTADOR
        function simularPedidos() {
            setInterval(() => {
                const lista = document.getElementById('lista-pedidos');
                const div = document.createElement('div');
                div.className = 'provider-card active-card';
                div.innerHTML = `
                    <b>Novo Cliente (Centro)</b><br>
                    Precisa de: Entrega R√°pida<br>
                    <button class="btn" style="margin-top:5px; padding:10px;" onclick="aceitar(this)">ACEITAR</button>
                `;
                lista.prepend(div);
                
                // Toca som se poss√≠vel
                try { new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play(); } catch(e){}
            }, 5000); // Cria um pedido a cada 5s
        }

        function aceitar(btn) {
            btn.parentElement.innerHTML = '<b style="color:green">ACEITO! üéâ Abrindo WhatsApp...</b>';
            setTimeout(() => { btn.parentElement.remove(); }, 2000);
        }

        // UTILS
        function criarFakes(lat, lng) {
            L.marker([lat + 0.002, lng + 0.002], {icon: icons.bike}).addTo(map).bindPopup('Jo√£o');
            L.marker([lat - 0.002, lng - 0.001], {icon: icons.ape}).addTo(map).bindPopup('Maria');
        }
        
        function centralizar() {
            if(myMarker) {
                const ll = myMarker.getLatLng();
                map.setView(ll, 17);
            }
        }
        
        function msg(texto) { alert(texto); }

    </script>
</body>
</html>
