<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MVP Carro Livre</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; font-family: 'Arial', sans-serif; background: #f4f4f4; overflow: hidden; }
        
        /* TELA DE LOGIN */
        #login { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; z-index: 2000; display: flex; flex-direction: column; 
            justify-content: center; padding: 30px; 
        }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        input, select, button { 
            width: 100%; padding: 15px; margin: 8px 0; border: 1px solid #ddd; 
            border-radius: 8px; font-size: 1rem; box-sizing: border-box; 
        }
        button { background: #000; color: #fff; font-weight: bold; border: none; cursor: pointer; }
        button:active { opacity: 0.8; }

        /* APP PRINCIPAL */
        #app { display: none; width: 100%; height: 100vh; position: relative; }
        
        /* BARRA SUPERIOR */
        #top { 
            position: absolute; top: 10px; left: 10px; right: 10px; 
            background: rgba(0,0,0,0.8); color: #fff; padding: 10px; 
            border-radius: 10px; z-index: 1000; display: flex; 
            align-items: center; justify-content: space-between; gap: 10px; 
        }
        .status-badge { font-weight: bold; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; }
        .st-free { background: #00c853; color: white; }
        .st-off { background: #555; color: #ccc; }
        .st-busy { background: #ffcc00; color: black; }
        .st-alert { background: #ff3b30; color: white; animation: blink 1s infinite; }

        /* MAPA */
        #map { width: 100%; height: 100%; z-index: 1; }

        @keyframes blink { 50% { opacity: 0.5; } }
        
        .hidden { display: none !important; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>

    <div id="login">
        <h2>ACESSO R√ÅPIDO</h2>
        <input id="nome" placeholder="Seu Nome">
        <input id="celular" type="tel" placeholder="Seu WhatsApp (s√≥ n√∫meros)">
        <input id="pin" type="number" placeholder="PIN de Seguran√ßa (S√≥ Motorista)">
        <select id="tipo">
            <option value="passageiro">Sou Passageiro</option>
            <option value="motorista">Sou Motorista</option>
        </select>
        <button onclick="entrar()">ENTRAR</button>
    </div>

    <div id="app">
        <div id="top">
            <span id="displayStatus" class="status-badge st-off">OFFLINE</span>
            <div style="display:flex; gap:5px;">
                <button id="btnOnline" onclick="toggleOnline()" style="display:none; padding:5px 10px; width:auto; font-size:0.8rem;">ONLINE</button>
                <button id="btnPanic" onclick="alerta()" style="display:none; background:#ff3b30; padding:5px 10px; width:auto;">üö®</button>
                <button onclick="share()" style="background:#007aff; padding:5px 10px; width:auto;">üì≤</button>
                <button onclick="sair()" style="background:#333; padding:5px 10px; width:auto;">‚ùå</button>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // --- CONFIGURA√á√ÉO (SUAS CHAVES REAIS) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBxbRiYNuGde5nwJIaoeRItWdZGR221cpY",
            authDomain: "rota-direta.firebaseapp.com",
            databaseURL: "https://rota-direta-default-rtdb.firebaseio.com",
            projectId: "rota-direta",
            storageBucket: "rota-direta.firebasestorage.app",
            messagingSenderId: "468273971962",
            appId: "1:468273971962:web:f536de2e2aa74f84dfff43"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- VARI√ÅVEIS ---
        let userId, tipo, map, marker;
        let online = false;
        let lastPing = Date.now();
        let markers = {};
        let watchId = null;

        // --- L√ìGICA DE LOGIN ---
        function entrar() {
            const nome = document.getElementById("nome").value;
            const celular = document.getElementById("celular").value.replace(/\D/g,''); // Limpa zap
            const pin = document.getElementById("pin").value;
            tipo = document.getElementById("tipo").value;

            if (!nome || !celular) return alert("Preencha Nome e Celular");
            if (tipo === 'motorista' && !pin) return alert("Motorista precisa de PIN");

            // Cria ID √∫nico (Base64 simples para teste)
            userId = btoa(celular + (tipo === 'motorista' ? pin : 'pas'));

            // Salva cadastro b√°sico
            db.ref((tipo === 'motorista' ? 'drivers/' : 'passengers/') + userId).set({ nome, celular });

            // UI
            document.getElementById("login").classList.add("hidden");
            document.getElementById("app").style.display = 'block';

            if(tipo === 'motorista') {
                document.getElementById('btnOnline').style.display = 'block';
                document.getElementById('btnPanic').style.display = 'block';
            }

            initMap();
            
            // Passageiro escuta carros, Motorista s√≥ se posiciona
            if (tipo === "passageiro") ouvirMotoristas();
        }

        // --- MAPA ---
        function initMap() {
            map = L.map("map", {zoomControl: false}).setView([-23.55, -46.63], 13);
            L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png").addTo(map);
            
            // Centraliza no user
            navigator.geolocation.getCurrentPosition(pos => {
                map.setView([pos.coords.latitude, pos.coords.longitude], 15);
                // Bolinha azul (Eu)
                L.circleMarker([pos.coords.latitude, pos.coords.longitude], {radius:8}).addTo(map);
            });
        }

        // --- MOTORISTA: ONLINE/OFFLINE ---
        function toggleOnline() {
            if (tipo !== "motorista") return;

            online = !online;
            atualizarStatusUI(online ? "LIVRE" : "OFFLINE");
            const btn = document.getElementById("btnOnline");
            
            if (online) {
                btn.innerText = "FICAR OFFLINE";
                btn.style.background = "#555";
                rastrear();
            } else {
                btn.innerText = "FICAR ONLINE";
                btn.style.background = "#000";
                if(watchId) navigator.geolocation.clearWatch(watchId);
                db.ref("online/" + userId).remove();
            }
        }

        function rastrear() {
            watchId = navigator.geolocation.watchPosition(pos => {
                lastPing = Date.now();
                const { latitude, longitude } = pos.coords;

                const dados = {
                    lat: latitude,
                    lng: longitude,
                    status: "LIVRE",
                    nome: document.getElementById("nome").value,
                    celular: document.getElementById("celular").value,
                    lastPing
                };

                // Atualiza ou cria
                db.ref("online/" + userId).update(dados);

            }, null, {enableHighAccuracy: true});

            // Auto-Offline se inativo por 10min
            setInterval(() => {
                if (online && Date.now() - lastPing > 600000) toggleOnline();
            }, 60000);
        }

        function alerta() {
            if (!online) return alert("Fique online primeiro!");
            db.ref("online/" + userId).update({status: "ALERTA"});
            alert("ALERTA ENVIADO!");
            
            // Volta ao normal em 20s (exemplo)
            setTimeout(() => {
                db.ref("online/" + userId).update({status: "LIVRE"});
            }, 20000);
        }

        // --- PASSAGEIRO: ESCUTAR ---
        function ouvirMotoristas() {
            db.ref("online").on("value", snap => {
                const list = snap.val() || {};
                
                // Limpa marcadores
                Object.values(markers).forEach(m => map.removeLayer(m));
                markers = {};

                Object.keys(list).forEach(key => {
                    const d = list[key];
                    
                    // Cor do √≠cone
                    let color = 'green';
                    if(d.status === 'OCUPADO') color = 'gold';
                    if(d.status === 'ALERTA') color = 'red';

                    const html = `<div style="background:${color}; width:20px; height:20px; border-radius:50%; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.5);"></div>`;
                    const icon = L.divIcon({ className: 'custom', html: html });

                    const m = L.marker([d.lat, d.lng], {icon}).addTo(map);
                    
                    m.bindPopup(`
                        <b>${d.nome}</b><br>
                        Status: ${d.status}<br><br>
                        <button onclick="ocupar('${key}', '${d.celular}')" style="background:#25D366; padding:5px; border-radius:5px; color:white; border:none; width:100%;">CHAMAR WHATSAPP</button>
                    `);
                    
                    markers[key] = m;
                });
            });
        }

        // --- L√ìGICA DE OCUPAR (Janela Global) ---
        window.ocupar = function(idDriver, zap) {
            // Marca como ocupado
            db.ref("online/" + idDriver).update({status: "OCUPADO"});
            
            // Abre WhatsApp
            window.open(`https://wa.me/55${zap}?text=Ol√°, vi seu carro no app e quero uma corrida!`, '_blank');

            // Timer para liberar (simula√ß√£o de 10 min)
            setTimeout(() => {
                db.ref("online/" + idDriver).update({status: "LIVRE"});
            }, 600000);
        };

        function atualizarStatusUI(status) {
            const badge = document.getElementById("displayStatus");
            badge.innerText = status;
            badge.className = "status-badge"; // reset
            if(status === 'LIVRE') badge.classList.add('st-free');
            else if(status === 'OFFLINE') badge.classList.add('st-off');
            else if(status === 'ALERTA') badge.classList.add('st-alert');
            else badge.classList.add('st-busy');
        }

        function share() {
            if(navigator.share) navigator.share({title: "Carro Livre", url: location.href});
            else alert("Link: " + location.href);
        }

        function sair() {
            location.reload();
        }

    </script>
</body>
</html>
