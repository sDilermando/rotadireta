<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <title>Rota Direta Final</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --bg:#f8f9fa; --surface:#fff; --dark:#1a1a1a; --gold:#FFC107; --green:#2ecc71; }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; width: 100%; height: 100vh; background: var(--bg); font-family: 'Montserrat', sans-serif; overflow: hidden; display: flex; flex-direction: column; }

        /* LOADING */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--surface); z-index: 10000; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; color: #888; flex-direction: column; gap: 15px; }

        /* SPLASH */
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--surface); z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; }
        .logo { font-size: 2.2rem; font-weight: 900; color: var(--dark); margin-bottom: 40px; }
        .logo span { color: var(--gold); }
        .btn-big { width: 100%; max-width: 320px; padding: 18px; margin-bottom: 15px; border: none; border-radius: 12px; font-size: 1rem; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .b-driver { background: var(--dark); color: white; }
        .b-pass { background: white; color: var(--dark); border: 2px solid var(--dark); }
        .version-tag { margin-top: 30px; color: green; font-size: 0.8rem; font-weight: bold; }

        /* APP */
        #app-ui { display: none; flex: 1; position: relative; }
        #map { width: 100%; height: 100%; z-index: 1; }
        .top-bar { position: absolute; top: 40px; left: 20px; right: 20px; background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); padding: 12px 20px; border-radius: 50px; z-index: 1000; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .driver-dock { position: absolute; bottom: 30px; left: 20px; right: 20px; background: var(--surface); padding: 20px; border-radius: 20px; z-index: 1000; box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center; display: none; }
        .btn-status { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 800; font-size: 1rem; text-transform: uppercase; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .s-off { background: #eee; color: #777; }
        .s-on { background: var(--green); color: white; animation: glow 2s infinite; }
        @keyframes glow { 0% { box-shadow: 0 0 0 0 rgba(46,204,113,0.7); } 70% { box-shadow: 0 0 0 15px rgba(46,204,113,0); } 100% { box-shadow: 0 0 0 0 rgba(46,204,113,0); } }
        
        .car-sheet { position: absolute; bottom: 0; left: 0; width: 100%; background: var(--surface); border-radius: 25px 25px 0 0; padding: 30px; z-index: 2000; box-shadow: 0 -5px 40px rgba(0,0,0,0.2); transform: translateY(110%); transition: transform 0.3s; }
        .car-sheet.open { transform: translateY(0); }
        .btn-zap { width: 100%; padding: 16px; background: #25D366; color: white; border: none; border-radius: 14px; font-weight: 800; font-size: 1rem; display: flex; justify-content: center; align-items: center; gap: 10px; text-decoration: none; margin-top: 20px; }
        
        .pin-box { position: relative; width: 50px; height: 50px; }
        .pin-label { position: absolute; top: -18px; left: 50%; transform: translateX(-50%); background: var(--green); color: white; font-size: 0.6rem; font-weight: 800; padding: 3px 8px; border-radius: 6px; white-space: nowrap; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .pin-img { width: 40px; height: 40px; background-image: url('https://cdn-icons-png.flaticon.com/512/3202/3202926.png'); background-size: cover; display: block; margin: 0 auto; filter: drop-shadow(0 4px 3px rgba(0,0,0,0.3)); }
    </style>
</head>
<body>

    <div id="loading"><i class="fas fa-circle-notch fa-spin fa-2x"></i><span>Conectando...</span></div>

    <div id="splash">
        <div class="logo">ROTA <span>DIRETA</span></div>
        <button class="btn-big b-driver" onclick="fluxoMotorista()"><i class="fas fa-car"></i> SOU MOTORISTA</button>
        <button class="btn-big b-pass" onclick="fluxoPassageiro()"><i class="fas fa-user"></i> SOU PASSAGEIRO</button>
        <div class="version-tag">Versão 3.5 (Conectada)</div>
        <div onclick="resetar()" style="margin-top:10px; font-size:0.7rem; color:#aaa; text-decoration:underline; cursor:pointer;">Resetar Dados</div>
    </div>

    <div id="app-ui">
        <div class="top-bar">
            <div style="font-weight:900;">ROTA<span style="color:var(--gold)">DIRETA</span></div>
            <div class="user-id" id="txtUser">...</div>
        </div>
        <div id="map"></div>
        <div class="driver-dock" id="driverDock">
            <button id="btnOnline" class="btn-status s-off" onclick="toggleOnline()">
                <i class="fas fa-power-off"></i> <span>FICAR ONLINE</span>
            </button>
        </div>
        <div class="car-sheet" id="carSheet">
            <div style="text-align:right;"><span onclick="fecharSheet()" style="font-size:1.5rem; color:#aaa; cursor:pointer;">&times;</span></div>
            <h3 id="dName" style="margin:0 0 5px 0;">Motorista</h3>
            <p id="dCar" style="color:#666; margin:0;">Carro</p>
            <a href="#" id="btnZap" class="btn-zap" target="_blank"><i class="fab fa-whatsapp"></i> CHAMAR</a>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBxbRiYNuGde5nwJIaoeRItWdZGR221cpY",
            authDomain: "rota-direta.firebaseapp.com",
            projectId: "rota-direta",
            storageBucket: "rota-direta.firebasestorage.app",
            messagingSenderId: "468273971962",
            appId: "1:468273971962:web:f536de2e2aa74f84dfff43",
            databaseURL: "https://rota-direta-default-rtdb.firebaseio.com"
        };

        try { firebase.initializeApp(firebaseConfig); } catch(e) {}
        const db = firebase.database();
        const auth = firebase.auth();
        
        let map, currentUser, userType, isOnline = false, watchId, markers = {};

        window.onload = () => {
            // Se o Auth não carregar, avisa
            if(!auth) return alert("Erro crítico: Firebase não carregou.");

            auth.signInAnonymously().then(() => {
                document.getElementById('loading').style.display = 'none';
                verificarCache();
            }).catch(e => {
                alert("Erro de conexão: " + e.message);
                document.getElementById('loading').innerHTML = "ERRO: " + e.message;
            });
        };

        function verificarCache() {
            const drv = localStorage.getItem('rd_driver_v35');
            const pas = localStorage.getItem('rd_pass_v35');
            if (drv) pedirSenhaMotorista(JSON.parse(drv));
            else if (pas) iniciarApp('passenger', JSON.parse(pas));
        }

        async function fluxoMotorista() {
            try {
                const { value: form } = await Swal.fire({
                    title: 'Cadastro Motorista',
                    html: `<input id="mNome" class="swal2-input" placeholder="Nome"><input id="mCarro" class="swal2-input" placeholder="Carro"><input id="mZap" class="swal2-input" type="tel" placeholder="WhatsApp">`,
                    confirmButtonText: 'CRIAR', confirmButtonColor: '#222',
                    preConfirm: () => {
                        const nome = document.getElementById('mNome').value;
                        const zap = document.getElementById('mZap').value;
                        if(!nome || !zap) return Swal.showValidationMessage('Preencha nome e zap');
                        return { uid: auth.currentUser.uid, pin: Math.floor(1000+Math.random()*9000), nome, carro: document.getElementById('mCarro').value, zap: zap.replace(/\D/g, '') };
                    }
                });

                if(form) {
                    await Swal.fire('Sucesso', `Sua senha: ${form.pin}`, 'success');
                    db.ref('drivers/'+form.uid).set(form);
                    localStorage.setItem('rd_driver_v35', JSON.stringify(form));
                    iniciarApp('driver', form);
                }
            } catch(e) {
                // Fallback se o SweetAlert falhar
                const nome = prompt("Nome:");
                if(nome) {
                    const form = { uid: auth.currentUser.uid, pin: 1234, nome: nome, zap: '00', carro: 'Carro' };
                    localStorage.setItem('rd_driver_v35', JSON.stringify(form));
                    iniciarApp('driver', form);
                }
            }
        }

        async function pedirSenhaMotorista(data) {
            const { value: pin } = await Swal.fire({
                title: `Olá ${data.nome}`, text: 'Senha PIN', input: 'text', inputAttributes: {inputmode:'numeric'}, confirmButtonText: 'ENTRAR', confirmButtonColor: '#222'
            });
            if (pin == data.pin) { data.uid = auth.currentUser.uid; iniciarApp('driver', data); }
            else { localStorage.removeItem('rd_driver_v35'); location.reload(); }
        }

        async function fluxoPassageiro() {
            const { value: form } = await Swal.fire({
                title: 'Passageiro', html: `<input id="pNome" class="swal2-input" placeholder="Nome">`, confirmButtonText: 'ENTRAR', confirmButtonColor: '#222',
                preConfirm: () => { return { uid: auth.currentUser.uid, nome: document.getElementById('pNome').value }; }
            });
            if(form) {
                localStorage.setItem('rd_pass_v35', JSON.stringify(form));
                iniciarApp('passenger', form);
            }
        }

        function iniciarApp(type, data) {
            userType = type; currentUser = data;
            document.getElementById('splash').style.display = 'none';
            document.getElementById('app-ui').style.display = 'flex';
            document.getElementById('txtUser').innerText = data.nome;
            if(type === 'driver') document.getElementById('driverDock').style.display = 'block';
            carregarMapa();
        }

        function carregarMapa() {
            if(!map) {
                map = L.map('map', { zoomControl: false }).setView([-23.55, -46.63], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            }
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => map.setView([pos.coords.latitude, pos.coords.longitude], 15));
            }
            escutarOnline();
        }

        function toggleOnline() {
            const btn = document.getElementById('btnOnline');
            if(!isOnline) {
                if(!navigator.geolocation) return Swal.fire('Erro', 'Ligue o GPS', 'warning');
                isOnline = true;
                btn.className = 'btn-status s-on';
                btn.innerHTML = 'VOCÊ ESTÁ VISÍVEL';
                watchId = navigator.geolocation.watchPosition(pos => {
                    db.ref('online/'+currentUser.uid).set({ ...currentUser, lat: pos.coords.latitude, lng: pos.coords.longitude });
                }, null, { enableHighAccuracy: true });
            } else {
                isOnline = false;
                btn.className = 'btn-status s-off';
                btn.innerHTML = 'FICAR ONLINE';
                if(watchId) navigator.geolocation.clearWatch(watchId);
                db.ref('online/'+currentUser.uid).remove();
            }
        }

        function escutarOnline() {
            db.ref('online').on('value', snap => {
                const list = snap.val() || {};
                for(let uid in markers) { if(!list[uid]) { map.removeLayer(markers[uid]); delete markers[uid]; } }
                for(let uid in list) {
                    if(userType === 'driver' && uid == currentUser.uid) continue;
                    const d = list[uid];
                    const icon = L.divIcon({ className: 'custom', html: `<div class="pin-box"><div class="pin-label">LIVRE</div><div class="pin-img"></div></div>`, iconSize: [50, 50] });
                    if(markers[uid]) markers[uid].setLatLng([d.lat, d.lng]);
                    else {
                        const m = L.marker([d.lat, d.lng], {icon}).addTo(map);
                        m.on('click', () => {
                            document.getElementById('dName').innerText = d.nome;
                            document.getElementById('dCar').innerText = d.carro;
                            document.getElementById('btnZap').href = `https://wa.me/55${d.zap}`;
                            document.getElementById('carSheet').classList.add('open');
                        });
                        markers[uid] = m;
                    }
                }
            });
        }
        function fecharSheet() { document.getElementById('carSheet').classList.remove('open'); }
        function resetar() { localStorage.clear(); location.reload(); }
        window.onbeforeunload = () => { if(isOnline) db.ref('online/'+currentUser.uid).remove(); };
    </script>
</body>
</html>
