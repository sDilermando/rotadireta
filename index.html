<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EcoRota | Oficial</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3202/3202926.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --primary: #059669; --dark: #0f172a; --bg: #f8fafc; --radius: 12px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--bg); overflow: hidden; height: 100vh; width: 100vw; color: var(--dark); }

        /* TELAS */
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 50; display: flex; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        .hidden { display: none !important; }
        .center-content { display:flex; flex-direction:column; align-items:center; justify-content:center; width:100%; min-height:100%; }

        /* DESIGN GERAL */
        .brand { font-size: 2rem; font-weight: 800; color: var(--dark); margin-bottom: 20px; letter-spacing: -1px; text-align: center; }
        .brand span { color: var(--primary); }
        .w-box { width: 100%; max-width: 340px; }

        /* FORMUL√ÅRIO */
        .tab-group { display: flex; background: #f1f5f9; padding: 4px; border-radius: 10px; margin-bottom: 15px; width: 100%; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: transparent; border-radius: 8px; font-weight: 600; color: #64748b; transition: 0.2s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .input-field { width: 100%; padding: 14px; border: 1px solid #cbd5e1; border-radius: var(--radius); font-size: 0.95rem; margin-bottom: 10px; outline: none; background: white; }
        .legal-box { height: 100px; overflow-y: auto; background: #f8fafc; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 0.7rem; color: #475569; text-align: justify; margin-bottom: 10px; }
        .legal-title { font-weight: bold; display: block; margin-top: 5px; }

        /* BOT√ïES */
        .btn { width: 100%; padding: 14px; border: none; border-radius: var(--radius); font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; margin-top: 5px; }
        .btn:disabled { opacity: 0.5; }
        .btn-primary { background: var(--dark); color: white; }
        .btn-eco { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(5, 150, 105, 0.2); }
        .btn-google { background: white; border: 1px solid #cbd5e1; color: #334155; margin-bottom: 20px; }

        /* BOT√ïES FLUTUANTES */
        .ui-float { position: absolute; z-index: 150; }
        .top-left { top: 20px; left: 20px; }
        .top-right { top: 20px; right: 20px; }
        .icon-btn { width: 45px; height: 45px; border-radius: 50%; background: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; color: var(--dark); }
        .sos-btn { background: #ef4444; color: white; animation: pulse 2s infinite; font-weight: bold; font-size: 0.8rem; }

        /* MAPA E PAIN√âIS */
        #map { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; }
        .bottom-panel { position: absolute; bottom: 0; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; padding: 20px; box-shadow: 0 -10px 30px rgba(0,0,0,0.1); transform: translateY(120%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); z-index: 100; max-height: 80vh; overflow-y: auto; }
        .panel-visible { transform: translateY(0); }

        /* RADAR OVERLAY */
        #radar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 200; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; }
        .radar-circle { width: 200px; height: 200px; border: 2px solid rgba(16, 185, 129, 0.3); border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; }
        .radar-scan { width: 100%; height: 100%; border-radius: 50%; border-top: 2px solid #10b981; border-right: 2px solid transparent; position: absolute; animation: spin-radar 1.5s linear infinite; box-shadow: 0 0 15px rgba(16, 185, 129, 0.5); }
        .status-badge { background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; color: #10b981; margin-bottom: 10px; border: 1px solid rgba(16, 185, 129, 0.3); }
        
        @keyframes spin-radar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* PEDIDOS */
        .order-card { background: #ecfdf5; border: 1px solid #d1fae5; padding: 15px; border-radius: 12px; margin-bottom: 10px; }
        .badge-veh { background: #059669; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.7rem; }
    </style>
</head>
<body>

    <div id="screen-auth" class="screen">
        <div class="center-content w-box">
            <div class="brand">Eco<span>Rota</span></div>
            <button class="btn btn-google" onclick="showForm()">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Entrar com Google
            </button>
            <div id="auth-form" class="hidden w-box">
                <div class="tab-group">
                    <button class="tab-btn active" onclick="switchRole('user')" id="btn-tab-user">Sou Cliente</button>
                    <button class="tab-btn" onclick="switchRole('prov')" id="btn-tab-prov">Sou Prestador</button>
                </div>
                <input id="input-name" class="input-field" placeholder="Nome Completo">
                <input id="input-phone" class="input-field" type="tel" placeholder="WhatsApp (DDD)">
                <div id="group-vehicle" class="hidden">
                    <select id="input-veh" class="input-field">
                        <option value="" disabled selected>Selecione Ve√≠culo</option>
                        <option value="Bike">üö≤ Bicicleta</option>
                        <option value="E-Bike">‚ö° E-Bike</option>
                        <option value="Patinete">üõ¥ Patinete</option>
                        <option value="A P√©">üëü A P√©</option>
                    </select>
                </div>
                <div class="legal-box">
                    <span class="legal-title">CONTRATO DE ADES√ÉO</span>
                    1. A EcoRota √© intermediadora tecnol√≥gica P2P.<br>
                    2. Risco integral assumido pelo usu√°rio.<br>
                    3. Proibido ve√≠culos a combust√£o.<br>
                    4. Dados usados apenas para conex√£o.<br>
                    <span class="legal-title">RESPONSABILIDADE</span>
                    Voc√™ isenta a plataforma de danos ou atrasos.
                </div>
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                    <input type="checkbox" id="check-terms" onchange="toggleEnterBtn()">
                    <label for="check-terms" style="font-size:0.8rem;">Li e Aceito os Termos.</label>
                </div>
                <button id="btn-enter" class="btn btn-eco" onclick="doLogin()" disabled>ENTRAR</button>
            </div>
        </div>
    </div>

    <div id="radar-overlay" class="hidden">
        <div class="status-badge" id="radar-badge">FASE 1/3</div>
        <div class="radar-circle">
            <div class="radar-scan"></div>
            <i class="fas fa-search-location" style="font-size:3rem; color:white;"></i>
        </div>
        <div style="font-size:1.5rem; font-weight:bold; margin-bottom:5px;" id="radar-main">Buscando...</div>
        <div style="color:#94a3b8; font-size:0.9rem;" id="radar-sub">Varrendo 500m</div>
        <button onclick="cancelarPedido()" style="margin-top:30px; background:transparent; border:1px solid #64748b; color:white; padding:8px 20px; border-radius:20px;">Cancelar</button>
    </div>

    <div id="screen-map" class="screen hidden" style="background:transparent; padding:0; display:block;">
        <div id="map"></div>

        <div class="ui-float top-left">
            <button class="icon-btn" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i></button>
        </div>
        <div class="ui-float top-right">
            <button class="icon-btn sos-btn" onclick="sos()">SOS</button>
        </div>

        <div id="panel-user" class="bottom-panel">
            <h3>Nova Solicita√ß√£o</h3>
            <select id="req-type" class="input-field">
                <option value="Bike">üö≤ Bike (Encomenda)</option>
                <option value="E-Bike">‚ö° E-Bike (R√°pido)</option>
                <option value="A P√©">üëü A P√© (Curto)</option>
            </select>
            <input id="req-desc" class="input-field" placeholder="O que precisa? (Ex: Levar chave)">
            <button class="btn btn-primary" onclick="iniciarRadar()">SOLICITAR AGORA</button>
        </div>

        <div id="panel-prov" class="bottom-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Pedidos</h3>
                <span class="badge-veh">ONLINE</span>
            </div>
            <div id="orders-list" style="max-height:50vh; overflow-y:auto;">
                <p style="text-align:center; color:#94a3b8; padding:20px;">Aguardando chamados...</p>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBxbRiYNuGde5nwJIaoeRItWdZGR221cpY",
            authDomain: "rota-direta.firebaseapp.com",
            databaseURL: "https://rota-direta-default-rtdb.firebaseio.com",
            projectId: "rota-direta",
            storageBucket: "rota-direta.firebasestorage.app",
            messagingSenderId: "468273971962",
            appId: "1:468273971962:web:f536de2e2aa74f84dfff43"
        };

        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        } catch(e) { console.error(e); }

        let map, role = 'user', currentUser = {}, currentOrderId = null;
        let radarPhase = 1;
        const audioAlert = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        window.onload = () => { IMask(document.getElementById('input-phone'), {mask:'(00) 00000-0000'}); };

        function showForm() {
            document.querySelector('.btn-google').classList.add('hidden');
            document.getElementById('auth-form').classList.remove('hidden');
        }

        function switchRole(r) {
            role = r;
            document.getElementById('btn-tab-user').className = `tab-btn ${r==='user'?'active':''}`;
            document.getElementById('btn-tab-prov').className = `tab-btn ${r==='prov'?'active':''}`;
            role === 'prov' ? document.getElementById('group-vehicle').classList.remove('hidden') : document.getElementById('group-vehicle').classList.add('hidden');
        }

        function toggleEnterBtn() {
            document.getElementById('btn-enter').disabled = !document.getElementById('check-terms').checked;
        }

        function doLogin() {
            const name = document.getElementById('input-name').value.trim();
            const phone = document.getElementById('input-phone').value;
            if(name.split(' ').length < 2) return Swal.fire('Nome', 'Digite nome e sobrenome.', 'warning');
            if(phone.length < 14) return Swal.fire('Zap', 'N√∫mero incompleto.', 'warning');
            
            currentUser = { name, phone };
            if(role === 'prov') {
                const v = document.getElementById('input-veh').value;
                if(!v) return Swal.fire('Ve√≠culo', 'Selecione ve√≠culo.', 'warning');
                currentUser.vehicle = v;
            }

            document.getElementById('screen-auth').classList.add('hidden');
            document.getElementById('screen-map').classList.remove('hidden');
            initMap();

            if(role === 'user') {
                document.getElementById('panel-user').classList.add('panel-visible');
            } else {
                document.getElementById('panel-prov').classList.add('panel-visible');
                escutarPedidos();
            }
        }

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([-21.135, -44.261], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            
            // √çCONE CORRIGIDO: CLIENTE (BONECO), PRESTADOR (CICLISTA)
            const iconUrl = role === 'user' 
                ? 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png' 
                : 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png'; // CICLISTA

            navigator.geolocation.getCurrentPosition(p => {
                currentUser.lat = p.coords.latitude; currentUser.lng = p.coords.longitude;
                map.setView([currentUser.lat, currentUser.lng], 16);
                L.marker([currentUser.lat, currentUser.lng], {icon: L.icon({iconUrl:iconUrl, iconSize:[40,40]})}).addTo(map);
            }, ()=>{}, {enableHighAccuracy:true});
        }

        function iniciarRadar() {
            const desc = document.getElementById('req-desc').value;
            if(!desc) return Swal.fire('Onde?', 'Descreva o pedido.', 'info');

            const ref = db.ref('orders').push();
            currentOrderId = ref.key;
            ref.set({
                id: currentOrderId,
                clientName: currentUser.name,
                clientPhone: currentUser.phone,
                type: document.getElementById('req-type').value,
                desc: desc,
                status: 'pending',
                timestamp: Date.now()
            });

            document.getElementById('panel-user').classList.remove('panel-visible');
            document.getElementById('radar-overlay').classList.remove('hidden');
            radarPhase = 1;
            runRadarSequence();

            ref.on('value', snap => {
                const data = snap.val();
                if(data && data.status === 'accepted') {
                    document.getElementById('radar-overlay').classList.add('hidden');
                    audioAlert.play();
                    Swal.fire({
                        title: 'Parceiro Encontrado! üåü',
                        html: `<h3 style="color:#059669;">+1 Estrela Eco</h3><p><b>${data.provName}</b> a caminho.</p>`,
                        confirmButtonText: '<i class="fab fa-whatsapp"></i> ABRIR WHATSAPP',
                        confirmButtonColor: '#25D366'
                    }).then(() => {
                        window.open(`https://wa.me/55${data.provPhone.replace(/\D/g,'')}`, '_blank');
                        location.reload();
                    });
                }
            });
        }

        function runRadarSequence() {
            const badge = document.getElementById('radar-badge');
            const main = document.getElementById('radar-main');
            const sub = document.getElementById('radar-sub');

            if(radarPhase === 1) {
                badge.innerText = "FASE 1/3"; main.innerText = "Buscando..."; sub.innerText = "Varrendo per√≠metro (500m)";
                setTimeout(() => { if(currentOrderId) { radarPhase=2; runRadarSequence(); } }, 10000);
            } else if(radarPhase === 2) {
                badge.innerText = "FASE 2/3"; main.innerText = "Expandindo Radar..."; sub.innerText = "Raio aumentado para 2km";
                setTimeout(() => { if(currentOrderId) { radarPhase=3; runRadarSequence(); } }, 10000);
            } else if(radarPhase === 3) {
                badge.innerText = "FASE 3/3"; main.innerText = "Prioridade M√°xima"; sub.innerText = "Varrendo toda a cidade";
                setTimeout(() => { 
                    if(currentOrderId) { 
                        // FIM DO PROCESSO: NINGU√âM ACEITOU
                        document.getElementById('radar-overlay').classList.add('hidden');
                        cancelarPedido(); // Remove do banco
                        Swal.fire({
                            title: 'Desculpe!',
                            text: 'Nossos parceiros est√£o ocupados devido √† alta demanda. Por favor, tente novamente em 5 minutos.',
                            icon: 'info',
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: '#64748b'
                        });
                    } 
                }, 10000);
            }
        }

        function escutarPedidos() {
            db.ref('orders').orderByChild('status').equalTo('pending').on('value', snap => {
                const list = document.getElementById('orders-list');
                list.innerHTML = '';
                if(!snap.exists()) { list.innerHTML = '<p style="text-align:center; color:#94a3b8; padding:20px;">Sem pedidos.</p>'; return; }
                audioAlert.play().catch(e=>{});
                snap.forEach(child => {
                    const o = child.val();
                    const div = document.createElement('div');
                    div.className = 'order-card';
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between;"><b>${o.clientName}</b> <span class="badge-veh">${o.type}</span></div>
                        <p style="margin:5px 0;">"${o.desc}"</p>
                        <button class="btn btn-eco" style="padding:10px;" onclick="aceitar('${o.id}')">ACEITAR</button>
                    `;
                    list.prepend(div);
                });
            });
        }

        function aceitar(id) {
            db.ref('orders/'+id).update({ status: 'accepted', provName: currentUser.name, provPhone: currentUser.phone, provVeh: currentUser.vehicle });
            Swal.fire('Sucesso', 'Corrida aceita!', 'success');
        }

        function cancelarPedido() { if(currentOrderId) { db.ref('orders/'+currentOrderId).remove(); location.reload(); } }
        function sos() { window.open('tel:190'); }
    </script>
</body>
</html>
