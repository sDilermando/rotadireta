<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EcoRota | App Real</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3202/3202926.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --primary: #10b981; --dark: #0f172a; --light: #f8fafc; --gray: #64748b; --radius: 12px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--light); overflow: hidden; height: 100vh; width: 100vw; color: var(--dark); }

        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; transition: opacity 0.3s ease; }
        .hidden { display: none !important; }
        .w-full { width: 100%; }
        
        .brand { font-size: 2.5rem; font-weight: 800; color: var(--dark); letter-spacing: -1px; margin-bottom: 30px; }
        .brand span { color: var(--primary); }

        .input-field { width: 100%; padding: 16px; border: 1px solid #cbd5e1; border-radius: var(--radius); font-size: 1rem; margin-bottom: 15px; outline: none; background: #fff; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: var(--radius); font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 12px; }
        .btn-primary { background: var(--dark); color: white; }
        .btn-eco { background: var(--primary); color: white; }
        .btn-outline { background: white; border: 2px solid #e2e8f0; color: #64748b; }

        /* MAPA */
        #map { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; filter: saturate(0.8); }
        .ui-float { position: absolute; z-index: 100; pointer-events: none; width: 100%; height: 100%; }
        .pointer { pointer-events: auto; }

        .bottom-panel { position: absolute; bottom: 0; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; padding: 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); transform: translateY(120%); transition: 0.3s; }
        .panel-visible { transform: translateY(0); }

        /* LISTA DE PEDIDOS (PRESTADOR) */
        #orders-list { max-height: 300px; overflow-y: auto; width: 100%; }
        .order-card { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 15px; border-radius: 12px; margin-bottom: 10px; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(-20px); opacity:0; } to { transform: translateX(0); opacity:1; } }

        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; margin-bottom: 5px; }
        .st-pending { background: #fef3c7; color: #d97706; }
        .st-accepted { background: #dcfce7; color: #166534; }
    </style>
</head>
<body>

    <div id="screen-home" class="screen">
        <div class="brand">Eco<span>Rota</span></div>
        <div class="w-full" style="max-width:320px;">
            <button class="btn btn-primary" onclick="gotoLogin('user')">SOU USU√ÅRIO</button>
            <button class="btn btn-outline" onclick="gotoLogin('prov')">SOU PRESTADOR</button>
        </div>
        <p style="margin-top:20px; font-size:0.8rem; color:#10b981;">‚óè Sistema Conectado</p>
    </div>

    <div id="screen-login" class="screen hidden">
        <h3 id="login-title">Seus Dados</h3>
        <div class="w-full" style="max-width:320px;">
            <div id="div-veh" class="hidden">
                <select id="reg-veh" class="input-field">
                    <option value="" disabled selected>Ve√≠culo</option>
                    <option value="Bike">üö≤ Bicicleta</option>
                    <option value="E-Bike">‚ö° Bike El√©trica</option>
                    <option value="Patinete">üõ¥ Patinete</option>
                    <option value="A P√©">üëü A P√©</option>
                </select>
            </div>
            <input id="reg-name" class="input-field" placeholder="Nome Completo">
            <input id="reg-phone" class="input-field" type="tel" placeholder="WhatsApp">
            
            <div style="font-size:0.8rem; margin-bottom:20px;">
                <input type="checkbox" id="terms"> Aceito os termos de uso (P2P).
            </div>

            <button class="btn btn-eco" onclick="doLogin()">ENTRAR</button>
            <button class="btn btn-link" onclick="location.reload()" style="background:none; border:none; color:#999;">Voltar</button>
        </div>
    </div>

    <div id="screen-map" class="screen hidden" style="background:transparent; padding:0;">
        <div id="map"></div>

        <div id="panel-user" class="bottom-panel pointer">
            <h3>Nova Solicita√ß√£o</h3>
            <select id="req-type" class="input-field">
                <option value="Bike">üö≤ Bike (Encomenda)</option>
                <option value="E-Bike">‚ö° E-Bike (R√°pido)</option>
                <option value="A P√©">üëü A P√© (Curto)</option>
            </select>
            <input id="req-desc" class="input-field" placeholder="O que precisa? (Ex: Levar chaves)">
            <button class="btn btn-primary" onclick="criarPedido()">SOLICITAR AGORA</button>
        </div>

        <div id="panel-waiting" class="bottom-panel pointer text-center">
            <div style="font-size:3rem; margin-bottom:10px;">üì°</div>
            <h3>Procurando Parceiro...</h3>
            <p style="color:#64748b;">Seu pedido est√° vis√≠vel para os prestadores.</p>
            <button class="btn btn-outline" onclick="cancelarPedido()">CANCELAR</button>
        </div>

        <div id="panel-prov" class="bottom-panel pointer">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Pedidos Dispon√≠veis</h3>
                <span class="status-badge st-accepted">üü¢ ONLINE</span>
            </div>
            <div id="orders-list">
                <p style="text-align:center; color:#94a3b8; padding:20px;">Aguardando chamados...</p>
            </div>
        </div>
    </div>

    <script>
        // --- SUAS CHAVES DO FIREBASE VINCULADAS ---
        const firebaseConfig = {
            apiKey: "AIzaSyBxbRiYNuGde5nwJIaoeRItWdZGR221cpY",
            authDomain: "rota-direta.firebaseapp.com",
            databaseURL: "https://rota-direta-default-rtdb.firebaseio.com",
            projectId: "rota-direta",
            storageBucket: "rota-direta.firebasestorage.app",
            messagingSenderId: "468273971962",
            appId: "1:468273971962:web:f536de2e2aa74f84dfff43"
        };

        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("Firebase Conectado com Sucesso!");
        } catch(e) {
            console.error("Erro Firebase", e);
            Swal.fire('Erro', 'Falha ao conectar no servidor.', 'error');
        }

        let map, role = 'user', currentUser = {}, currentOrderId = null;
        const audioPing = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        window.onload = () => { IMask(document.getElementById('reg-phone'), {mask:'(00) 00000-0000'}); };

        function gotoLogin(r) {
            role = r;
            document.getElementById('screen-home').classList.add('hidden');
            document.getElementById('screen-login').classList.remove('hidden');
            if(role === 'prov') document.getElementById('div-veh').classList.remove('hidden');
        }

        function doLogin() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const terms = document.getElementById('terms').checked;

            if(!terms) return Swal.fire('Termos', '√â necess√°rio aceitar os termos.', 'warning');
            if(!name || phone.length < 14) return Swal.fire('Erro', 'Preencha tudo corretamente.', 'warning');
            
            currentUser = { name, phone };
            
            if(role === 'prov') {
                currentUser.vehicle = document.getElementById('reg-veh').value;
                if(!currentUser.vehicle) return Swal.fire('Erro', 'Escolha ve√≠culo.', 'warning');
            }

            document.getElementById('screen-login').classList.add('hidden');
            document.getElementById('screen-map').classList.remove('hidden');
            initMap();

            if(role === 'user') {
                document.getElementById('panel-user').classList.add('panel-visible');
            } else {
                document.getElementById('panel-prov').classList.add('panel-visible');
                escutarPedidos(); 
            }
        }

        function initMap() {
            map = L.map('map', {zoomControl: false}).setView([-21.135, -44.261], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            
            // √çcone diferente para user e prestador
            const iconUrl = role === 'user' 
                ? 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png' // User
                : 'https://cdn-icons-png.flaticon.com/512/94/94203.png'; // Prestador

            const customIcon = L.icon({iconUrl: iconUrl, iconSize: [30, 30]});

            navigator.geolocation.getCurrentPosition(p => {
                const lat = p.coords.latitude;
                const lng = p.coords.longitude;
                currentUser.lat = lat; currentUser.lng = lng;
                map.setView([lat, lng], 16);
                L.marker([lat, lng], {icon: customIcon}).addTo(map);
            });
        }

        // --- USU√ÅRIO: CRIA PEDIDO NA NUVEM ---
        function criarPedido() {
            if(!db) return Swal.fire('Erro', 'Sistema offline.', 'error');

            const type = document.getElementById('req-type').value;
            const desc = document.getElementById('req-desc').value;
            if(!desc) return Swal.fire('Onde?', 'Descreva o pedido.', 'question');

            const newOrderRef = db.ref('orders').push();
            currentOrderId = newOrderRef.key;

            const orderData = {
                id: currentOrderId,
                user: currentUser.name,
                phone: currentUser.phone,
                type: type,
                desc: desc,
                lat: currentUser.lat || 0,
                lng: currentUser.lng || 0,
                status: 'pending',
                timestamp: Date.now()
            };

            newOrderRef.set(orderData);

            document.getElementById('panel-user').classList.remove('panel-visible');
            document.getElementById('panel-waiting').classList.add('panel-visible');

            // Monitora resposta
            newOrderRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if(data && data.status === 'accepted') {
                    audioPing.play();
                    // GAMIFICA√á√ÉO FINAL + LINK ZAP
                    Swal.fire({
                        title: 'ACEITO! üåü',
                        html: `
                            <h3 style="color:#065f46;">+1 Estrela Eco</h3>
                            <p><b>${data.providerName}</b> aceitou a corrida.</p>
                            <p>Ve√≠culo: ${data.providerVeh}</p>
                        `,
                        confirmButtonText: '<i class="fab fa-whatsapp"></i> FALAR COM PRESTADOR',
                        confirmButtonColor: '#25D366'
                    }).then(() => {
                        window.open(`https://wa.me/55${data.providerPhone.replace(/\D/g,'')}`, '_blank');
                        location.reload();
                    });
                }
            });
        }

        // --- PRESTADOR: ESCUTA NUVEM ---
        function escutarPedidos() {
            if(!db) return;

            db.ref('orders').orderByChild('status').equalTo('pending').on('value', (snapshot) => {
                const list = document.getElementById('orders-list');
                list.innerHTML = '';
                
                if(!snapshot.exists()) {
                    list.innerHTML = '<p style="text-align:center; color:#94a3b8; padding:20px;">Sem pedidos pendentes.</p>';
                    return;
                }

                // Toca som se houver pedido novo
                audioPing.play().catch(()=>{});

                snapshot.forEach((child) => {
                    const order = child.val();
                    const el = document.createElement('div');
                    el.className = 'order-card';
                    el.innerHTML = `
                        <div style="display:flex; justify-content:space-between;">
                            <b>${order.user}</b>
                            <span class="status-badge st-pending">${order.type}</span>
                        </div>
                        <p>${order.desc}</p>
                        <button class="btn btn-eco" style="margin-top:10px; padding:10px;" onclick="aceitarPedido('${order.id}')">ACEITAR</button>
                    `;
                    list.prepend(el);
                });
            });
        }

        function aceitarPedido(orderId) {
            db.ref('orders/' + orderId).update({
                status: 'accepted',
                providerName: currentUser.name,
                providerPhone: currentUser.phone,
                providerVeh: currentUser.vehicle
            });
            Swal.fire('Pegou!', 'Voc√™ aceitou. O cliente foi avisado.', 'success');
        }

        function cancelarPedido() {
            if(currentOrderId) {
                db.ref('orders/' + currentOrderId).remove();
                location.reload();
            }
        }
    </script>
</body>
</html>
