<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EcoRota | Mobilidade Urbana</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3202/3202926.png">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/imask/6.4.3/imask.min.js"></script>

    <style>
        /* DESIGN SYSTEM STARTUP */
        :root {
            --primary: #10b981; /* Emerald Green */
            --dark: #0f172a;    /* Slate 900 */
            --light: #f8fafc;   /* Slate 50 */
            --gray: #64748b;    /* Slate 500 */
            --error: #ef4444;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Roboto', sans-serif; background: var(--light); overflow: hidden; height: 100vh; width: 100vw; color: var(--dark); }

        /* UTILIT√ÅRIOS */
        .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; transition: opacity 0.3s ease; }
        .hidden { display: none !important; }
        .w-full { width: 100%; }
        .max-w-md { max-width: 400px; }
        .text-center { text-align: center; }
        
        /* LOGO MODERNA */
        .brand { font-size: 2rem; font-weight: 800; color: var(--dark); letter-spacing: -1px; margin-bottom: 8px; }
        .brand span { color: var(--primary); }
        .tagline { color: var(--gray); font-size: 0.9rem; margin-bottom: 32px; font-weight: 400; }

        /* INPUTS ESTILO MATERIAL */
        .input-group { position: relative; margin-bottom: 16px; width: 100%; }
        .input-field { width: 100%; padding: 16px; border: 1px solid #cbd5e1; border-radius: var(--radius); font-size: 1rem; transition: 0.2s; outline: none; background: #fff; }
        .input-field:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        .input-label { position: absolute; left: 16px; top: 16px; color: var(--gray); pointer-events: none; transition: 0.2s; font-size: 1rem; background: white; padding: 0 4px; }
        .input-field:focus ~ .input-label, .input-field:not(:placeholder-shown) ~ .input-label { top: -10px; font-size: 0.8rem; color: var(--primary); font-weight: 600; }

        /* BOT√ïES */
        .btn { width: 100%; padding: 16px; border: none; border-radius: var(--radius); font-weight: 600; font-size: 1rem; cursor: pointer; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; gap: 8px; box-shadow: var(--shadow); }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--dark); color: white; }
        .btn-eco { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 2px solid #e2e8f0; color: var(--gray); box-shadow: none; }
        .btn-link { background: none; color: var(--primary); box-shadow: none; font-size: 0.9rem; margin-top: 10px; }

        /* TERMOS JUR√çDICOS */
        .legal-box { height: 180px; overflow-y: scroll; background: #f1f5f9; padding: 16px; border-radius: var(--radius); font-size: 0.8rem; line-height: 1.5; color: var(--gray); border: 1px solid #e2e8f0; margin-bottom: 16px; text-align: justify; }
        
        /* MAPA CLEAN */
        #map { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; filter: saturate(0.8); }
        
        /* INTERFACE FLUTUANTE */
        .ui-float { position: absolute; z-index: 100; }
        .top-left { top: 20px; left: 20px; }
        .top-right { top: 20px; right: 20px; }
        .bottom-center { bottom: 40px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; }

        .icon-btn { width: 48px; height: 48px; border-radius: 50%; background: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; color: var(--dark); transition: 0.2s; }
        .icon-btn:hover { transform: translateY(-2px); }
        .sos-btn { background: var(--error); color: white; animation: pulse 2s infinite; font-weight: 700; font-size: 0.8rem; }

        /* MODAL DE BUSCA/PRESTADOR */
        .search-modal { background: white; border-radius: 20px; padding: 24px; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); width: 100%; }
        .provider-profile { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
        .avatar { width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); }
        .p-info h3 { margin: 0; font-size: 1.1rem; }
        .p-info p { margin: 4px 0 0; font-size: 0.9rem; color: var(--gray); }
        .stars { color: #fbbf24; font-size: 0.9rem; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body>

    <div id="screen-auth" class="screen">
        <div class="brand">Eco<span>Rota</span></div>
        <div class="tagline">Mobilidade Profissional Sustent√°vel</div>
        
        <div class="w-full max-w-md">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn btn-outline" id="tab-user" onclick="switchTab('user')">Usu√°rio</button>
                <button class="btn btn-outline" id="tab-prov" onclick="switchTab('prov')">Prestador</button>
            </div>

            <div id="form-login">
                <div class="input-group">
                    <input type="tel" id="login-phone" class="input-field" placeholder=" ">
                    <label class="input-label">Celular (DDD)</label>
                </div>
                <div class="input-group hidden" id="div-pass">
                    <input type="password" id="login-pass" class="input-field" placeholder=" ">
                    <label class="input-label">Senha de Acesso</label>
                </div>
                
                <button class="btn btn-primary" onclick="processLogin()">ENTRAR</button>
                <button class="btn btn-link" onclick="openRegister()">N√£o tem conta? Cadastre-se</button>
            </div>
        </div>
        <p style="position:absolute; bottom:20px; color:#cbd5e1; font-size:0.75rem;">v35.0 Enterprise Build</p>
    </div>

    <div id="screen-register" class="screen hidden">
        <h2 style="margin-top:0;">Criar Conta</h2>
        <p style="color:var(--gray); font-size:0.9rem; margin-bottom:20px;">Seguran√ßa em primeiro lugar.</p>
        
        <div class="w-full max-w-md" style="overflow-y:auto;">
            <div class="input-group">
                <input type="text" id="reg-name" class="input-field" placeholder=" ">
                <label class="input-label">Nome Completo (Sem abrevia√ß√µes)</label>
            </div>
            <div class="input-group">
                <input type="tel" id="reg-phone" class="input-field" placeholder=" ">
                <label class="input-label">WhatsApp V√°lido</label>
            </div>
            
            <div id="prov-fields" class="hidden">
                <div class="input-group">
                    <select id="reg-veh" class="input-field" style="background:white;">
                        <option value="" disabled selected>Selecione o Ve√≠culo</option>
                        <option value="Bike">üö≤ Bicicleta</option>
                        <option value="E-Bike">‚ö° Bike El√©trica</option>
                        <option value="Patinete">üõ¥ Patinete El√©trico</option>
                        <option value="A P√©">üëü Office Boy (A P√©)</option>
                    </select>
                </div>
            </div>

            <label style="font-weight:bold; font-size:0.9rem; display:block; margin-bottom:5px;">Termos de Uso Obrigat√≥rios</label>
            <div class="legal-box" id="legal-scroll">
                <p><strong>1. ACEITA√á√ÉO:</strong> Ao usar o EcoRota, voc√™ concorda com a pol√≠tica de toler√¢ncia zero para ve√≠culos poluentes.</p>
                <p><strong>2. VERACIDADE:</strong> O usu√°rio garante que seus dados s√£o reais. Perfis falsos ser√£o banidos.</p>
                <p><strong>3. SEGURAN√áA:</strong> O prestador √© um profissional aut√¥nomo. O EcoRota conecta partes e n√£o emprega motoristas.</p>
                <p><strong>4. DADOS:</strong> Seus dados s√£o protegidos e usados apenas para a presta√ß√£o do servi√ßo.</p>
                <p><strong>5. PAGAMENTOS:</strong> A plataforma √© isenta de transa√ß√µes financeiras.</p>
                <br><br><br>
                <p style="text-align:center; color:var(--primary);">Voc√™ chegou ao final.</p>
            </div>
            
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
                <input type="checkbox" id="check-terms" disabled>
                <label for="check-terms" style="font-size:0.9rem; color:var(--gray);">Li e aceito os termos.</label>
            </div>

            <button class="btn btn-eco" id="btn-reg-submit" onclick="submitRegister()" disabled>CONTINUAR</button>
            <button class="btn btn-link" onclick="location.reload()">Voltar ao Login</button>
        </div>
    </div>

    <div id="screen-verify" class="screen hidden">
        <div class="text-center">
            <i class="fas fa-shield-alt" style="font-size:3rem; color:var(--primary); margin-bottom:20px;"></i>
            <h3>Aprova√ß√£o Necess√°ria</h3>
            <p style="color:var(--gray); margin-bottom:30px;">Para garantir a seguran√ßa, seu cadastro precisa ser aprovado manualmente.</p>
            
            <button class="btn btn-outline" onclick="sendToAdmin()">1. ENVIAR DADOS (WHATSAPP)</button>
            <p style="font-size:0.8rem; margin:15px 0; color:#94a3b8;">Aguarde a senha que ser√° enviada pelo Admin.</p>
            
            <div class="input-group">
                <input type="text" id="verify-pass" class="input-field" placeholder=" " style="text-align:center; letter-spacing:3px; font-weight:bold;">
                <label class="input-label">2. Digite a Senha Recebida</label>
            </div>
            
            <button class="btn btn-primary" onclick="activateAccount()">ATIVAR CONTA</button>
        </div>
    </div>

    <div id="screen-map" class="screen hidden" style="background:transparent; padding:0;">
        <div id="map"></div>

        <div class="ui-float top-left">
            <button class="icon-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
        </div>
        <div class="ui-float top-right">
            <button class="icon-btn sos-btn" onclick="sos()">SOS</button>
        </div>

        <div class="ui-float bottom-center hidden" id="panel-user">
            <div class="search-modal">
                <h3 style="margin-top:0;">Para onde vamos?</h3>
                <div class="input-group">
                    <select id="search-cat" class="input-field">
                        <option value="Bike">üö≤ Bike (Encomenda)</option>
                        <option value="E-Bike">‚ö° E-Bike (R√°pido)</option>
                        <option value="A P√©">üëü Office Boy (Curto)</option>
                    </select>
                </div>
                <div class="input-group">
                    <input id="search-desc" class="input-field" placeholder=" " type="text">
                    <label class="input-label">O que precisa fazer?</label>
                </div>
                <button class="btn btn-primary" onclick="startSearch()">BUSCAR PRESTADOR</button>
            </div>
        </div>

        <div class="ui-float bottom-center hidden" id="panel-prov">
            <div class="search-modal text-center">
                <div style="background:#dcfce7; color:#166534; padding:8px 16px; border-radius:50px; display:inline-block; font-weight:bold; margin-bottom:15px;">
                    üü¢ VOC√ä EST√Å ONLINE
                </div>
                <p style="color:var(--gray);">Aguardando chamados...</p>
                <div id="prov-notification" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO DO ADMIN
        const ADMIN_PHONE = "5532984099000"; 
        
        let map, userRole = 'user';
        let currentMarker;

        // --- M√ÅSCARAS E INICIALIZA√á√ÉO ---
        window.onload = () => {
            IMask(document.getElementById('login-phone'), {mask:'(00) 00000-0000'});
            IMask(document.getElementById('reg-phone'), {mask:'(00) 00000-0000'});
            
            // L√≥gica do Scroll dos Termos
            const box = document.getElementById('legal-scroll');
            box.addEventListener('scroll', () => {
                if(box.scrollTop + box.clientHeight >= box.scrollHeight - 10) {
                    document.getElementById('check-terms').disabled = false;
                }
            });
            
            document.getElementById('check-terms').addEventListener('change', (e) => {
                document.getElementById('btn-reg-submit').disabled = !e.target.checked;
            });

            // Auto-Login
            const saved = localStorage.getItem('ecoSession');
            if(saved) {
                const s = JSON.parse(saved);
                enterApp(s.role, s.name);
            }
        };

        // --- SISTEMA DE ABAS (LOGIN) ---
        function switchTab(role) {
            userRole = role;
            document.querySelectorAll('#screen-auth .btn-outline').forEach(b => {
                b.style.background = 'transparent'; 
                b.style.color = '#64748b';
                b.style.borderColor = '#e2e8f0';
            });
            
            const activeBtn = document.getElementById(role === 'user' ? 'tab-user' : 'tab-prov');
            activeBtn.style.background = 'var(--dark)';
            activeBtn.style.color = 'white';
            activeBtn.style.borderColor = 'var(--dark)';

            if(role === 'prov') {
                document.getElementById('div-pass').classList.remove('hidden');
            } else {
                document.getElementById('div-pass').classList.add('hidden');
            }
        }
        // Inicia na aba Usu√°rio visualmente
        switchTab('user');

        // --- L√ìGICA DE LOGIN ---
        function processLogin() {
            const phone = document.getElementById('login-phone').value;
            
            if(phone.length < 14) return Swal.fire('Erro', 'Digite um celular v√°lido.', 'error');

            if(userRole === 'user') {
                // Usu√°rio entra direto (Simula√ß√£o segura)
                enterApp('user', 'Visitante');
            } else {
                // Prestador precisa de senha
                const pass = document.getElementById('login-pass').value;
                const storedPass = localStorage.getItem('pass_' + phone.replace(/\D/g,''));
                
                if(pass && pass === storedPass) {
                    enterApp('prov', 'Prestador');
                } else {
                    Swal.fire('Acesso Negado', 'Senha incorreta ou conta inexistente.', 'error');
                }
            }
        }

        // --- CADASTRO RIGOROSO ---
        function openRegister() {
            document.getElementById('screen-auth').classList.add('hidden');
            document.getElementById('screen-register').classList.remove('hidden');
            
            if(userRole === 'prov') {
                document.getElementById('prov-fields').classList.remove('hidden');
            }
        }

        function submitRegister() {
            const name = document.getElementById('reg-name').value.trim();
            const phone = document.getElementById('reg-phone').value;
            
            // VALIDA√á√ÉO RIGOROSA
            if(name.split(' ').length < 2) return Swal.fire('Nome Inv√°lido', 'Digite Nome e Sobrenome.', 'warning');
            if(phone.length < 14) return Swal.fire('WhatsApp Inv√°lido', 'N√∫mero incorreto.', 'warning');

            if(userRole === 'prov') {
                const veh = document.getElementById('reg-veh').value;
                if(!veh) return Swal.fire('Ve√≠culo', 'Selecione seu transporte.', 'warning');
                
                // Vai para tela de verifica√ß√£o
                document.getElementById('screen-register').classList.add('hidden');
                document.getElementById('screen-verify').classList.remove('hidden');
            } else {
                // Usu√°rio cadastra e entra
                localStorage.setItem('ecoSession', JSON.stringify({role:'user', name:name}));
                Swal.fire('Sucesso', 'Cadastro realizado!', 'success').then(() => enterApp('user', name));
            }
        }

        // --- APROVA√á√ÉO DO ADMIN (ZAP) ---
        function sendToAdmin() {
            const name = document.getElementById('reg-name').value;
            const phone = document.getElementById('reg-phone').value;
            const veh = document.getElementById('reg-veh').value;
            
            const msg = `*SOLICITA√á√ÉO DE CADASTRO*%0A%0ANome: ${name}%0AZap: ${phone}%0AVe√≠culo: ${veh}%0A%0APor favor, gere minha senha de acesso.`;
            window.open(`https://wa.me/${ADMIN_PHONE}?text=${msg}`, '_blank');
        }

        function activateAccount() {
            const pass = document.getElementById('verify-pass').value;
            const phone = document.getElementById('reg-phone').value.replace(/\D/g,'');
            
            if(pass.length < 3) return Swal.fire('Senha Inv√°lida', 'Digite a senha que o Admin enviou.', 'error');
            
            // Salva a senha para o futuro
            localStorage.setItem('pass_' + phone, pass);
            localStorage.setItem('ecoSession', JSON.stringify({role:'prov', name:document.getElementById('reg-name').value}));
            
            Swal.fire('Conta Ativada!', 'Bem-vindo ao time.', 'success').then(() => enterApp('prov', ''));
        }

        // --- APP PRINCIPAL ---
        function enterApp(role, name) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById('screen-map').classList.remove('hidden');
            
            initMap(); // Mapa Inicia LIMPO

            if(role === 'user') {
                document.getElementById('panel-user').classList.remove('hidden');
            } else {
                document.getElementById('panel-prov').classList.remove('hidden');
            }
        }

        function initMap() {
            if(map) return;
            // Estilo Clean (CartoDB Positron)
            map = L.map('map', {zoomControl: false}).setView([-21.135, -44.261], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: ''
            }).addTo(map);

            // Tenta pegar localiza√ß√£o real
            navigator.geolocation.getCurrentPosition(p => {
                const lat = p.coords.latitude;
                const lng = p.coords.longitude;
                map.setView([lat, lng], 16);
                
                // √çcone EU
                L.marker([lat, lng], {
                    icon: L.divIcon({className:'', html:`<div style="width:16px;height:16px;background:#0f172a;border:3px solid white;border-radius:50%;box-shadow:0 0 0 4px rgba(0,0,0,0.1);"></div>`})
                }).addTo(map);
            });
        }

        // --- ALGORITMO DE BUSCA (A M√ÅGICA) ---
        function startSearch() {
            const cat = document.getElementById('search-cat').value;
            const desc = document.getElementById('search-desc').value;

            if(!desc) return Swal.fire('Onde?', 'Diga o que precisa ser feito.', 'question');

            // 1. Radar Animation
            Swal.fire({
                title: 'Localizando...',
                html: 'Buscando o melhor prestador <b>Eco</b> na regi√£o.',
                timer: 2500,
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            }).then(() => {
                // 2. Prestador Encontrado (Mockup Profissional)
                const providerName = "Carlos Mendes";
                const providerRating = "4.9";
                
                Swal.fire({
                    title: 'Prestador Encontrado',
                    html: `
                        <div class="provider-profile" style="justify-content:center; text-align:left;">
                            <img src="https://randomuser.me/api/portraits/men/45.jpg" class="avatar">
                            <div class="p-info">
                                <h3>${providerName}</h3>
                                <p>${cat} ‚Ä¢ <span class="stars">‚òÖ ${providerRating}</span></p>
                                <p style="font-size:0.8rem; color:green;">‚úÖ Verificado</p>
                            </div>
                        </div>
                        <div style="background:#f0fdf4; padding:10px; border-radius:8px; font-size:0.9rem; margin-bottom:15px;">
                            "Ol√°, estou a 3 minutos. Posso realizar: <b>${desc}</b>"
                        </div>
                    `,
                    confirmButtonText: 'ACEITAR E CONVERSAR',
                    confirmButtonColor: '#10b981',
                    showCancelButton: true,
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if(result.isConfirmed) {
                        showEcoImpact();
                    } else {
                        // Limpa o mapa se cancelar
                        if(currentMarker) map.removeLayer(currentMarker);
                    }
                });

                // Mostra o √≠cone dele no mapa AGORA
                const center = map.getCenter();
                const iconUrl = 'https://cdn-icons-png.flaticon.com/512/94/94203.png'; // Exemplo Bike
                const customIcon = L.icon({iconUrl: iconUrl, iconSize: [40, 40]});
                
                if(currentMarker) map.removeLayer(currentMarker);
                currentMarker = L.marker([center.lat + 0.001, center.lng + 0.001], {icon: customIcon}).addTo(map);
                
                // Zoom para mostrar os dois
                const group = new L.featureGroup([
                    L.marker(center), // Eu
                    currentMarker     // Ele
                ]);
                map.fitBounds(group.getBounds().pad(0.2));
            });
        }

        // --- GAMIFICA√á√ÉO IMPACTO ---
        function showEcoImpact() {
            Swal.fire({
                title: 'Impacto Positivo! üåç',
                html: `
                    <div style="margin:20px 0;">
                        <i class="fas fa-leaf" style="font-size:4rem; color:#10b981; animation:pulse 2s infinite;"></i>
                    </div>
                    <h3>Voc√™ economizou 0.4kg de CO2</h3>
                    <p>Ao escolher transporte limpo, voc√™ ajuda o futuro.</p>
                `,
                confirmButtonText: '<i class="fab fa-whatsapp"></i> ABRIR WHATSAPP',
                confirmButtonColor: '#25D366',
                allowOutsideClick: false
            }).then(() => {
                window.open(`https://wa.me/5532999999999`, '_blank');
            });
        }

        function logout() {
            localStorage.removeItem('ecoSession');
            location.reload();
        }
        function sos() { window.open('tel:190'); }

    </script>
</body>
</html>
